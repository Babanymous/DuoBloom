import React, { useState, useEffect, useMemo } from 'react';
import { createRoot } from 'react-dom/client';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  addDoc,
  getDoc, 
  onSnapshot, 
  updateDoc, 
  increment, 
  arrayUnion,
  serverTimestamp,
  runTransaction,
  query,
  orderBy,
  limit
} from 'firebase/firestore';
import { 
  Sprout, 
  Droplet, 
  CheckSquare, 
  ShoppingBag, 
  Users, 
  Gem, 
  Coins, 
  Shovel, 
  ArrowRight,
  Share2,
  Heart,
  Clock,
  Menu,
  X
} from 'lucide-react';

// --- GAME CONSTANTS ---

const ITEMS = {
  'seed_carrot': { 
    id: 'seed_carrot', 
    name: 'Carrot Seed', 
    type: 'plant', 
    cost: 50, 
    currency: 'coins', 
    icon: 'ðŸ¥•', 
    stages: 3, 
    sellPrice: 5, 
    sellCurrency: 'gems',
    waterInterval: 1 // simplified for demo
  },
  'seed_flower': { 
    id: 'seed_flower', 
    name: 'Rose Bush', 
    type: 'plant', 
    cost: 150, 
    currency: 'coins', 
    icon: 'ðŸŒ¹', 
    stages: 4, 
    sellPrice: 15, 
    sellCurrency: 'gems',
    waterInterval: 1
  },
  'seed_tree': { 
    id: 'seed_tree', 
    name: 'Apple Tree', 
    type: 'plant', 
    cost: 500, 
    currency: 'coins', 
    icon: 'ðŸŒ³', 
    stages: 5, 
    sellPrice: 50, 
    sellCurrency: 'gems',
    waterInterval: 1
  },
  'deco_fence': {
    id: 'deco_fence',
    name: 'Wooden Fence',
    type: 'decor',
    cost: 200,
    currency: 'coins',
    icon: 'ðŸªµ',
    stages: 1, // Decor doesn't grow
    sellPrice: 0,
    sellCurrency: 'none'
  }
};

const EXPANSION_COST = 50; // Gems
const STARTING_COINS = 0;
const FIRST_TASK_REWARD = 100;

// --- FIREBASE SETUP ---

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- COMPONENTS ---

// 1. LOGIN / LOBBY
const Lobby = ({ user, joinRoom, createRoom, loading }) => {
  const [roomInput, setRoomInput] = useState('');
  const [nameInput, setNameInput] = useState('');

  return (
    <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-4">
      <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
        <div className="flex justify-center mb-4">
          <div className="bg-green-100 p-4 rounded-full">
            <Sprout size={48} className="text-green-600" />
          </div>
        </div>
        <h1 className="text-3xl font-bold text-gray-800 mb-2">Our Garden</h1>
        <p className="text-gray-500 mb-8">Productivity meets Cozy Farming.</p>

        <div className="space-y-4">
          <div className="text-left">
            <label className="text-xs font-bold text-gray-400 uppercase">Start a New Garden</label>
            <input 
              type="text" 
              placeholder="Give your garden a name" 
              className="w-full mt-1 p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
              value={nameInput}
              onChange={(e) => setNameInput(e.target.value)}
            />
            <button 
              onClick={() => createRoom(nameInput)}
              disabled={loading || !nameInput.trim()}
              className="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors disabled:opacity-50"
            >
              {loading ? 'Creating...' : 'Create New Garden'}
            </button>
          </div>

          <div className="relative flex py-2 items-center">
            <div className="flex-grow border-t border-gray-200"></div>
            <span className="flex-shrink-0 mx-4 text-gray-400 text-sm">OR</span>
            <div className="flex-grow border-t border-gray-200"></div>
          </div>

          <div className="text-left">
            <label className="text-xs font-bold text-gray-400 uppercase">Join Existing</label>
            <div className="flex gap-2 mt-1">
              <input 
                type="text" 
                placeholder="Enter Room ID" 
                className="flex-1 p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                value={roomInput}
                onChange={(e) => setRoomInput(e.target.value)}
              />
              <button 
                onClick={() => joinRoom(roomInput)}
                disabled={loading || !roomInput.trim()}
                className="bg-blue-500 hover:bg-blue-600 text-white px-6 rounded-lg font-semibold transition-colors disabled:opacity-50"
              >
                Join
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// 2. MAIN APP CONTAINER
const App = () => {
  const [user, setUser] = useState(null);
  const [roomId, setRoomId] = useState(null);
  const [roomData, setRoomData] = useState(null);
  const [userData, setUserData] = useState(null);
  const [activeTab, setActiveTab] = useState('garden'); // garden, tasks, shop, social
  const [loading, setLoading] = useState(false);

  // Auth Init
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Listen to User Data (Inventory/Currency)
  useEffect(() => {
    if (!user) return;
    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'profile');
    
    // Create user profile if not exists
    getDoc(userRef).then((snap) => {
      if (!snap.exists()) {
        setDoc(userRef, {
          coins: STARTING_COINS,
          gems: 0,
          inventory: {}
        });
      }
    });

    const unsub = onSnapshot(userRef, (snap) => {
      if (snap.exists()) setUserData(snap.data());
    }, (err) => console.error("User listener error:", err));

    return () => unsub();
  }, [user]);

  // Listen to Room Data (Garden Grid)
  useEffect(() => {
    if (!roomId) return;
    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}`);
    
    const unsub = onSnapshot(roomRef, (snap) => {
      if (snap.exists()) {
        setRoomData(snap.data());
      } else {
        setRoomId(null); // Kicked out or invalid
        alert("Room not found");
      }
    }, (err) => console.error("Room listener error:", err));

    return () => unsub();
  }, [roomId]);

  const handleCreateRoom = async (name) => {
    if (!user) return;
    setLoading(true);
    try {
      const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
      const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${newRoomId}`);
      
      // Initial 4x4 Grid
      const initialGrid = {};
      for(let i=0; i<16; i++) initialGrid[i] = null;

      await setDoc(roomRef, {
        id: newRoomId,
        name: name,
        owner: user.uid,
        members: [user.uid],
        expansionLevel: 4, // 4x4
        grid: initialGrid,
        likes: 0,
        createdAt: serverTimestamp(),
        simulatedDay: 0 // For demo purposes to fast forward time
      });
      setRoomId(newRoomId);
    } catch (e) {
      console.error(e);
      alert("Error creating room");
    }
    setLoading(false);
  };

  const handleJoinRoom = async (id) => {
    if (!user) return;
    setLoading(true);
    const cleanId = id.trim().toUpperCase();
    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${cleanId}`);
    const snap = await getDoc(roomRef);
    
    if (snap.exists()) {
      await updateDoc(roomRef, {
        members: arrayUnion(user.uid)
      });
      setRoomId(cleanId);
    } else {
      alert("Room not found!");
    }
    setLoading(false);
  };

  if (!user) return <div className="h-screen flex items-center justify-center text-green-600 animate-pulse">Initializing...</div>;

  if (!roomId) {
    return <Lobby user={user} joinRoom={handleJoinRoom} createRoom={handleCreateRoom} loading={loading} />;
  }

  return (
    <div className="max-w-md mx-auto h-screen bg-gray-50 flex flex-col relative shadow-2xl overflow-hidden">
      {/* Top Bar */}
      <div className="bg-white px-4 py-3 flex justify-between items-center shadow-sm z-10">
        <div>
          <h2 className="font-bold text-gray-800">{roomData?.name || 'Garden'}</h2>
          <div className="flex gap-3 text-xs font-medium mt-1">
            <span className="flex items-center text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-full">
              <Coins size={12} className="mr-1" /> {userData?.coins || 0}
            </span>
            <span className="flex items-center text-purple-600 bg-purple-50 px-2 py-0.5 rounded-full">
              <Gem size={12} className="mr-1" /> {userData?.gems || 0}
            </span>
          </div>
        </div>
        <div className="flex gap-2">
           <button 
            onClick={() => {
              navigator.clipboard.writeText(roomId);
              alert("Room ID copied: " + roomId);
            }}
            className="p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200"
          >
            <Share2 size={18} />
          </button>
           <button 
            onClick={() => setRoomId(null)}
            className="p-2 bg-gray-100 rounded-full text-red-400 hover:bg-red-50"
          >
            <X size={18} />
          </button>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="flex-1 overflow-hidden relative">
        {activeTab === 'garden' && <GardenView room={roomData} user={user} userData={userData} />}
        {activeTab === 'tasks' && <TasksView roomId={roomId} user={user} />}
        {activeTab === 'shop' && <ShopView user={user} userData={userData} />}
        {activeTab === 'social' && <SocialView roomId={roomId} />}
      </div>

      {/* Bottom Nav */}
      <div className="bg-white border-t border-gray-200 p-2 pb-6 flex justify-around items-center z-20">
        <NavButton icon={Sprout} label="Garden" active={activeTab === 'garden'} onClick={() => setActiveTab('garden')} />
        <NavButton icon={CheckSquare} label="Tasks" active={activeTab === 'tasks'} onClick={() => setActiveTab('tasks')} />
        <NavButton icon={ShoppingBag} label="Shop" active={activeTab === 'shop'} onClick={() => setActiveTab('shop')} />
        <NavButton icon={Users} label="Social" active={activeTab === 'social'} onClick={() => setActiveTab('social')} />
      </div>
    </div>
  );
};

const NavButton = ({ icon: Icon, label, active, onClick }) => (
  <button 
    onClick={onClick}
    className={`flex flex-col items-center justify-center w-16 transition-colors ${active ? 'text-green-600' : 'text-gray-400 hover:text-gray-600'}`}
  >
    <Icon size={24} strokeWidth={active ? 2.5 : 2} />
    <span className="text-[10px] mt-1 font-medium">{label}</span>
  </button>
);

// --- VIEWS ---

// 3. GARDEN VIEW
const GardenView = ({ room, user, userData }) => {
  const [selectedCell, setSelectedCell] = useState(null);
  
  // Logic to simulate time passing for the demo
  const simulateDay = async () => {
    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${room.id}`);
    await updateDoc(roomRef, {
      simulatedDay: increment(1)
    });
  };

  const handlePlant = async (itemId) => {
    if (!selectedCell && selectedCell !== 0) return;
    
    // Check if user has item
    const currentQty = userData.inventory?.[itemId] || 0;
    if (currentQty <= 0) {
      alert("You don't have this seed!");
      return;
    }

    // Remove from inventory, Add to Grid
    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${room.id}`);
    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'profile');

    try {
      await runTransaction(db, async (transaction) => {
        // Decrease Inventory
        transaction.update(userRef, {
          [`inventory.${itemId}`]: increment(-1)
        });

        // Update Grid
        transaction.update(roomRef, {
          [`grid.${selectedCell}`]: {
            type: itemId,
            plantedAtDay: room.simulatedDay || 0,
            waterLevel: 0,
            lastWateredDay: -1,
            stage: 0,
            plantedBy: user.uid
          }
        });
      });
      setSelectedCell(null);
    } catch (e) {
      console.error(e);
      alert("Failed to plant");
    }
  };

  const handleWater = async (cellIndex, cellData) => {
    if(cellData.lastWateredDay === room.simulatedDay) {
      alert("Already watered today!");
      return;
    }

    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${room.id}`);
    
    // Logic: If watered enough times, stage increases
    const itemConfig = ITEMS[cellData.type];
    let newStage = cellData.stage;
    let newWaterLevel = cellData.waterLevel + 1;

    // Simple growth logic: Every water grows it (for demo)
    // Real logic would be: if (newWaterLevel % itemConfig.waterInterval === 0) newStage++;
    newStage = Math.min(newStage + 1, itemConfig.stages);

    await updateDoc(roomRef, {
      [`grid.${cellIndex}.lastWateredDay`]: room.simulatedDay,
      [`grid.${cellIndex}.waterLevel`]: newWaterLevel,
      [`grid.${cellIndex}.stage`]: newStage
    });
  };

  const handleHarvest = async (cellIndex, cellData) => {
    const itemConfig = ITEMS[cellData.type];
    if (cellData.stage < itemConfig.stages) return;

    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${room.id}`);
    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'profile');

    try {
      await runTransaction(db, async (transaction) => {
        // Clear Grid
        transaction.update(roomRef, {
          [`grid.${cellIndex}`]: null
        });

        // Give Rewards (Gems)
        if (itemConfig.sellPrice > 0) {
            transaction.update(userRef, {
            [itemConfig.sellCurrency]: increment(itemConfig.sellPrice)
            });
        }
      });
    } catch (e) {
      console.error(e);
    }
  };

  const handleExpand = async () => {
      if(userData.gems < EXPANSION_COST) {
          alert("Not enough gems!");
          return;
      }
      
      const roomRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${room.id}`);
      const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'profile');

      try {
        await runTransaction(db, async (transaction) => {
             // 1. Deduct Gems
            transaction.update(userRef, { gems: increment(-EXPANSION_COST) });
            
            // 2. Expand Grid (add new null cells)
            // Current is expansionLevel^2. New is (expansionLevel+1)^2
            const currentSize = room.expansionLevel * room.expansionLevel;
            const newLevel = room.expansionLevel + 1;
            const newSize = newLevel * newLevel;
            
            const updates = { expansionLevel: newLevel };
            for(let i = currentSize; i < newSize; i++) {
                updates[`grid.${i}`] = null;
            }

            transaction.update(roomRef, updates);
        });
      } catch(e) {
          console.error(e);
          alert("Expansion failed");
      }
  };

  // Grid Generation
  const size = room?.expansionLevel || 4;
  const gridStyle = {
    gridTemplateColumns: `repeat(${size}, minmax(0, 1fr))`,
  };

  return (
    <div className="h-full flex flex-col bg-green-50 overflow-y-auto">
      {/* Simulation Controls */}
      <div className="bg-yellow-50 p-2 flex justify-between items-center border-b border-yellow-100">
        <span className="text-xs text-yellow-800 font-mono">Day: {room.simulatedDay || 0}</span>
        <button 
          onClick={simulateDay}
          className="bg-yellow-200 hover:bg-yellow-300 text-yellow-800 text-xs px-2 py-1 rounded flex items-center"
        >
          <Clock size={12} className="mr-1" /> Skip Day (Debug)
        </button>
      </div>

      <div className="flex-1 p-4 flex items-center justify-center">
        <div className="w-full max-w-[350px] aspect-square bg-stone-200 p-2 rounded-xl shadow-inner border-4 border-stone-300" 
             style={{ display: 'grid', gap: '4px', ...gridStyle }}>
          
          {Array.from({ length: size * size }).map((_, i) => {
            const cell = room.grid?.[i];
            const isSelected = selectedCell === i;
            
            return (
              <div 
                key={i}
                onClick={() => !cell && setSelectedCell(i)}
                className={`relative bg-[#8B5E3C] rounded-md shadow-sm flex items-center justify-center cursor-pointer transition-all hover:brightness-110 overflow-hidden
                  ${isSelected ? 'ring-4 ring-green-400 z-10' : ''}
                `}
              >
                 {/* Dirt Texture / Empty State */}
                 {!cell && <div className="opacity-10 text-black text-[8px]">{i}</div>}

                 {/* Plant State */}
                 {cell && (
                   <div className="flex flex-col items-center animate-bounce-short">
                      <span className="text-2xl filter drop-shadow-md">
                        {/* If stage 0, show seed packet or sprout */}
                        {cell.stage === 0 ? 'ðŸŒ±' : ITEMS[cell.type].icon}
                      </span>
                      {/* Growth Bar */}
                      {ITEMS[cell.type].stages > 1 && (
                         <div className="w-8 h-1 bg-gray-700 mt-1 rounded-full overflow-hidden">
                             <div 
                                className="h-full bg-green-500" 
                                style={{ width: `${(cell.stage / ITEMS[cell.type].stages) * 100}%` }} 
                             />
                         </div>
                      )}
                      
                      {/* Actions Overlay */}
                      <div className="absolute inset-0 bg-black/20 opacity-0 hover:opacity-100 flex items-center justify-center gap-1 transition-opacity backdrop-blur-[1px]">
                         {/* Water Button */}
                         {cell.stage < ITEMS[cell.type].stages && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); handleWater(i, cell); }}
                                className={`p-1.5 rounded-full ${cell.lastWateredDay === room.simulatedDay ? 'bg-gray-400' : 'bg-blue-500 text-white shadow-lg transform hover:scale-110'}`}
                            >
                                <Droplet size={14} />
                            </button>
                         )}
                         {/* Harvest Button */}
                         {cell.stage >= ITEMS[cell.type].stages && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); handleHarvest(i, cell); }}
                                className="p-1.5 bg-yellow-500 text-white rounded-full shadow-lg transform hover:scale-110 animate-pulse"
                            >
                                <Shovel size={14} />
                            </button>
                         )}
                      </div>
                   </div>
                 )}
              </div>
            );
          })}
        </div>
      </div>
      
      {/* Expansion Button */}
      <div className="p-4 flex justify-center pb-20">
          <button 
            onClick={handleExpand}
            className="flex items-center gap-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-full shadow-lg text-sm font-bold hover:shadow-xl transition-all"
          >
              <Gem size={16} /> Expand Land ({EXPANSION_COST})
          </button>
      </div>

      {/* Inventory Modal / Drawer */}
      {selectedCell !== null && (
        <div className="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl p-4 pb-24 z-20 animate-slide-up">
           <div className="flex justify-between items-center mb-3">
             <h3 className="font-bold text-gray-700">Select seed to plant</h3>
             <button onClick={() => setSelectedCell(null)} className="text-gray-400"><X size={20}/></button>
           </div>
           <div className="grid grid-cols-4 gap-2">
             {Object.keys(userData?.inventory || {}).map(itemId => {
                const count = userData.inventory[itemId];
                if(count <= 0) return null;
                const item = ITEMS[itemId];
                return (
                  <button 
                    key={itemId}
                    onClick={() => handlePlant(itemId)}
                    className="flex flex-col items-center p-2 bg-green-50 border border-green-100 rounded-lg hover:bg-green-100"
                  >
                    <span className="text-2xl mb-1">{item.icon}</span>
                    <span className="text-xs font-medium text-gray-600 truncate w-full text-center">{item.name}</span>
                    <span className="text-[10px] bg-green-200 text-green-800 px-1.5 rounded-full mt-1">x{count}</span>
                  </button>
                )
             })}
             {Object.keys(userData?.inventory || {}).length === 0 && (
                 <div className="col-span-4 text-center py-4 text-gray-400 text-sm">
                     You have no seeds! Visit the Shop.
                 </div>
             )}
           </div>
        </div>
      )}
    </div>
  );
};

// 4. TASKS VIEW
const TasksView = ({ roomId, user }) => {
  const [tasks, setTasks] = useState([]);
  const [newTask, setNewTask] = useState('');

  useEffect(() => {
    const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', `room_${roomId}`, 'tasks');
    const q = query(tasksRef, orderBy('createdAt', 'desc'), limit(50));
    
    const unsub = onSnapshot(q, (snap) => {
      setTasks(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });
    return () => unsub();
  }, [roomId]);

  const addTask = async () => {
    if (!newTask.trim()) return;
    const isFirstTask = tasks.length === 0; 
    
    const tasksRef = collection(db, 'artifacts', appId, 'public', 'data', `room_${roomId}`, 'tasks');
    await addDoc(tasksRef, {
      title: newTask,
      completed: false,
      createdBy: user.uid,
      reward: isFirstTask ? FIRST_TASK_REWARD : 10, // Logic for first task bonus
      createdAt: serverTimestamp()
    });
    setNewTask('');
  };

  const completeTask = async (task) => {
    if (task.completed) return;
    
    const taskRef = doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}`, 'tasks', task.id);
    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'profile');

    try {
        await runTransaction(db, async (t) => {
            t.update(taskRef, { 
                completed: true, 
                completedBy: user.uid,
                completedAt: serverTimestamp()
            });
            t.update(userRef, {
                coins: increment(task.reward)
            });
        });
    } catch(e) { console.error(e); }
  };

  return (
    <div className="h-full bg-gray-50 flex flex-col p-4 pb-24 overflow-y-auto">
      <div className="bg-white p-4 rounded-xl shadow-sm mb-4">
        <h3 className="text-sm font-bold text-gray-500 uppercase mb-2">New Task</h3>
        <div className="flex gap-2">
          <input 
            type="text" 
            value={newTask}
            onChange={(e) => setNewTask(e.target.value)}
            placeholder="e.g. Do 10 minutes of reading"
            className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
            onKeyDown={(e) => e.key === 'Enter' && addTask()}
          />
          <button 
            onClick={addTask}
            className="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700"
          >
            <ArrowRight size={20} />
          </button>
        </div>
      </div>

      <div className="space-y-2">
        {tasks.map(task => (
          <div key={task.id} className={`p-4 rounded-xl border flex items-center justify-between transition-all ${task.completed ? 'bg-gray-100 border-gray-100 opacity-60' : 'bg-white border-gray-200 shadow-sm'}`}>
            <div className="flex-1">
              <p className={`font-medium ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}`}>{task.title}</p>
              <span className="text-xs text-yellow-600 bg-yellow-50 px-1.5 py-0.5 rounded flex w-fit items-center mt-1">
                +{task.reward} Coins
              </span>
            </div>
            <button 
              onClick={() => completeTask(task)}
              disabled={task.completed}
              className={`p-2 rounded-full ${task.completed ? 'text-green-600' : 'text-gray-300 hover:text-green-500 hover:bg-green-50'}`}
            >
              <CheckSquare size={24} className={task.completed ? 'fill-current' : ''} />
            </button>
          </div>
        ))}
        {tasks.length === 0 && (
            <div className="text-center text-gray-400 mt-10">
                <p>No tasks yet. Create one to earn coins!</p>
                <p className="text-xs mt-2 text-yellow-600">First task gives {FIRST_TASK_REWARD} coins!</p>
            </div>
        )}
      </div>
    </div>
  );
};

// 5. SHOP VIEW
const ShopView = ({ user, userData }) => {
  const buyItem = async (itemId) => {
    const item = ITEMS[itemId];
    if (userData.coins < item.cost) {
      alert("Not enough coins!");
      return;
    }

    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'profile');
    try {
        await updateDoc(userRef, {
            coins: increment(-item.cost),
            [`inventory.${itemId}`]: increment(1)
        });
    } catch(e) { console.error(e); }
  };

  return (
    <div className="h-full bg-gray-50 p-4 pb-24 overflow-y-auto">
      <div className="bg-gradient-to-r from-orange-100 to-yellow-50 p-4 rounded-xl mb-6 shadow-sm border border-orange-200">
        <h2 className="text-lg font-bold text-orange-800 flex items-center">
            <ShoppingBag className="mr-2" size={20}/> General Store
        </h2>
        <p className="text-sm text-orange-600 opacity-80">Buy seeds to beautify your garden.</p>
      </div>

      <div className="grid grid-cols-1 gap-3">
        {Object.values(ITEMS).map(item => (
          <div key={item.id} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center">
            <div className="w-16 h-16 bg-gray-50 rounded-lg flex items-center justify-center text-4xl mr-4">
              {item.icon}
            </div>
            <div className="flex-1">
              <h3 className="font-bold text-gray-800">{item.name}</h3>
              <p className="text-xs text-gray-500">{item.type === 'plant' ? `Harvests for ${item.sellPrice} Gems` : 'Decoration'}</p>
            </div>
            <button 
              onClick={() => buyItem(item.id)}
              className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center hover:bg-green-700 transition-colors"
            >
              {item.cost} <Coins size={12} className="ml-1" />
            </button>
          </div>
        ))}
      </div>
    </div>
  );
};

// 6. SOCIAL VIEW
const SocialView = ({ roomId }) => {
    // This would ideally query all public rooms, but for now we just show a static placeholder
    // or info about the current room
    return (
        <div className="h-full bg-gray-50 p-4 flex flex-col items-center justify-center text-center">
            <div className="bg-white p-8 rounded-2xl shadow-sm max-w-sm">
                <Heart size={48} className="text-red-400 mx-auto mb-4" />
                <h2 className="text-xl font-bold text-gray-800 mb-2">Community Gardens</h2>
                <p className="text-gray-500 text-sm mb-6">
                    In a full version, you would see a list of other users' gardens here, like them, and visit them to see their progress!
                </p>
                <div className="p-4 bg-blue-50 rounded-lg border border-blue-100 text-blue-800 text-sm">
                    <strong>Current Room ID:</strong><br/>
                    <span className="font-mono text-lg select-all">{roomId}</span>
                </div>
            </div>
        </div>
    )
}

const root = createRoot(document.getElementById('root'));
root.render(<App />);

