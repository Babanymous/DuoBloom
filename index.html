<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoBloom 4.0 üå∑</title>
    
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .texture-stone {
            background-color: #d1d5db;
            background-image: radial-gradient(circle, #9ca3af 20%, transparent 20%), radial-gradient(circle, #9ca3af 20%, transparent 20%);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            border: 1px solid #9ca3af;
        }
        .texture-wood {
            background-color: #78350f;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.1) 5px, rgba(255,255,255,0.1) 10px);
            border: 1px solid #451a03;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        
        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen w-full overflow-hidden select-none font-sans">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, getDoc, getDocs,
            arrayUnion, arrayRemove, increment, deleteField, query, limit 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // =================================================================
        // ‚ö†Ô∏è F√úGE HIER DEINE FIREBASE CONFIG EIN ‚ö†Ô∏è
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDqEDD2Hds_pX5phI5cZKU3Q-mRtQxTZDg",
            authDomain: "duobloom-a9b7b.firebaseapp.com",
            projectId: "duobloom-a9b7b",
            storageBucket: "duobloom-a9b7b.firebasestorage.app",
            messagingSenderId: "118209789780",
            appId: "1:118209789780:web:ce2563e693a76f09a7d2c1",
            measurementId: "G-Z0W0LK6D88"
          };
        // =================================================================

        let app, auth, db;
        try {
            if (firebaseConfig.apiKey !== "HIER_API_KEY") {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) { console.error(e); }

        const WATER_COOLDOWN = 5000;

        const ITEMS = {
            carrot_seed: { id: 'carrot_seed', name: 'Karotte', type: 'seed', price: 20, icon: 'ü•ï', growsInto: 'carrot', stages: 3, reward: 5 },
            sunflower_seed: { id: 'sunflower_seed', name: 'Sonnenblume', type: 'seed', price: 60, icon: 'üåª', growsInto: 'sunflower', stages: 4, reward: 15 },
            stone_floor: { id: 'stone_floor', name: 'Steinweg', type: 'floor', price: 10, css: 'texture-stone', icon: 'ü™®' },
            wood_floor: { id: 'wood_floor', name: 'Holzboden', type: 'floor', price: 25, css: 'texture-wood', icon: 'ü™µ' },
            fence: { id: 'fence', name: 'Zaun', type: 'deco', price: 15, icon: 'üöß' },
            bench: { id: 'bench', name: 'Bank', type: 'deco', price: 150, icon: 'ü™ë' },
            gnome: { id: 'gnome', name: 'Zwerg', type: 'deco', price: 250, icon: 'üéÖ' },
        };

        const GARDEN_UPGRADES = [
            { id: 0, name: "Start-Garten", price: 0 },
            { id: 1, name: "Hinterhof", price: 100 },
            { id: 2, name: "Waldlichtung", price: 500 },
        ];

        // --- COMPONENTS ---

        const Modal = ({ children, onClose, title }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-pop">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]">
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                        <button onClick={onClose}><i data-lucide="x" className="text-gray-500 hover:text-red-500"></i></button>
                    </div>
                    <div className="p-4 overflow-y-auto">{children}</div>
                </div>
            </div>
        );

        // --- MAIN MENU ---
        const MainMenu = ({ user, onAction, currentRoom }) => {
            const [joinCode, setJoinCode] = React.useState("");

            return (
                <div className="h-full bg-slate-100 flex flex-col md:flex-row max-w-5xl mx-auto shadow-xl md:rounded-3xl md:my-8 md:h-[90vh] overflow-hidden">
                    <div className="md:w-1/3 bg-white p-8 flex flex-col items-center border-r border-gray-100">
                        <img src={user.photoURL} className="w-24 h-24 rounded-full border-4 border-green-500 mb-4 shadow-lg" />
                        <h1 className="text-2xl font-bold text-gray-800">{user.displayName}</h1>
                        <button onClick={() => auth.signOut()} className="mt-auto text-red-500 font-bold hover:bg-red-50 px-4 py-2 rounded-lg transition-colors">Abmelden</button>
                    </div>

                    <div className="flex-1 bg-[#f8fafc] p-8 flex flex-col justify-center gap-6">
                        <h2 className="text-3xl font-bold text-gray-700">Dein Dashboard</h2>
                        
                        {currentRoom && (
                            <button onClick={() => onAction('resume', currentRoom)} className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all text-left flex items-center justify-between group">
                                <div>
                                    <div className="text-green-100 text-sm font-bold uppercase mb-1">Letzte Sitzung</div>
                                    <div className="text-2xl font-bold">Garten betreten</div>
                                    <div className="text-sm opacity-80 font-mono mt-1">Code: {currentRoom}</div>
                                </div>
                                <i data-lucide="arrow-right" className="w-8 h-8 group-hover:translate-x-2 transition-transform"></i>
                            </button>
                        )}

                        <div className="grid grid-cols-1 gap-4">
                            <button onClick={() => onAction('create')} className="bg-white border-2 border-dashed border-gray-300 p-6 rounded-2xl text-gray-500 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 transition-all flex items-center gap-4">
                                <div className="bg-blue-100 p-3 rounded-full text-blue-500"><i data-lucide="plus"></i></div>
                                <span className="font-bold text-lg">Neuen Garten erstellen</span>
                            </button>
                            
                            <div className="bg-white border border-gray-200 p-6 rounded-2xl flex flex-col justify-center">
                                <label className="text-xs font-bold text-gray-400 uppercase mb-2">Code eingeben (Freund beitreten)</label>
                                <div className="flex gap-2">
                                    <input value={joinCode} onChange={e => setJoinCode(e.target.value.toUpperCase())} placeholder="z.B. A1B2C3" className="w-full bg-gray-100 rounded-lg px-4 py-3 font-bold uppercase focus:ring-2 ring-blue-500 outline-none" />
                                    <button onClick={() => joinCode && onAction('join', joinCode)} className="bg-blue-500 text-white px-6 rounded-lg font-bold hover:bg-blue-600 transition-colors">Go</button>
                                </div>
                            </div>
                            
                            <button onClick={() => onAction('community')} className="bg-purple-50 border border-purple-200 p-4 rounded-2xl text-purple-700 font-bold flex items-center justify-center gap-2 hover:bg-purple-100">
                                <i data-lucide="globe"></i> Community G√§rten besuchen
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- GAME APP (Playing & Spectating) ---
        const GameApp = ({ user, roomCode, isSpectator, onLeave }) => {
            const [roomData, setRoomData] = React.useState(null);
            const [tab, setTab] = React.useState('garden');
            const [activeGardenIdx, setActiveGardenIdx] = React.useState(0);
            const [selectedItem, setSelectedItem] = React.useState(null);
            
            // UI States
            const [isTaskModalOpen, setTaskModalOpen] = React.useState(false);
            const [newTaskTitle, setNewTaskTitle] = React.useState("");
            const [isEditingName, setIsEditingName] = React.useState(false);
            const [tempName, setTempName] = React.useState("");
            const [hasLiked, setHasLiked] = React.useState(false);

            // Sync Logic
            React.useEffect(() => {
                const unsub = onSnapshot(doc(db, 'rooms', roomCode), (snap) => {
                    if (snap.exists()) {
                        setRoomData(snap.data());
                    } else if (!isSpectator) {
                        // Init new Room only if not spectating
                        setDoc(doc(db, 'rooms', roomCode), {
                            roomName: "Unbenannter Garten",
                            coins: 50, gems: 0,
                            tasks: [],
                            inventory: {}, gardens: { 0: {} }, unlockedGardens: [0],
                            likes: 0, createdAt: new Date().toISOString(), owner: user.uid
                        });
                    }
                });
                // Check if user already liked this room (localstorage check)
                if (localStorage.getItem(`liked_${roomCode}`)) setHasLiked(true);
                
                return () => unsub();
            }, [roomCode, isSpectator]);

            // Fix White Screen: createIcons needs to be safer
            React.useEffect(() => { 
                try { lucide.createIcons(); } catch(e) {} 
            }, [roomData, tab, isEditingName]);

            // --- ACTIONS ---

            const updateName = async () => {
                if(tempName.trim()) {
                    try {
                        await updateDoc(doc(db, 'rooms', roomCode), { roomName: tempName });
                        setIsEditingName(false);
                    } catch(e) { console.error(e); setIsEditingName(false); }
                } else {
                    setIsEditingName(false);
                }
            };

            const handleLike = async () => {
                if(hasLiked) return;
                await updateDoc(doc(db, 'rooms', roomCode), { likes: increment(1) });
                localStorage.setItem(`liked_${roomCode}`, 'true');
                setHasLiked(true);
            };

            const handleGridClick = async (key) => {
                if (isSpectator) return; // Spectators cant touch

                const currentGrid = roomData.gardens[activeGardenIdx] || {};
                const cell = currentGrid[key] || {}; 
                const roomRef = doc(db, 'rooms', roomCode);
                const path = `gardens.${activeGardenIdx}.${key}`;

                if (selectedItem) {
                    const itemDef = ITEMS[selectedItem];
                    const invCount = roomData.inventory[selectedItem] || 0;
                    if (invCount > 0) {
                        if (itemDef.type === 'floor') await updateDoc(roomRef, { [`${path}.floor`]: selectedItem, [`inventory.${selectedItem}`]: increment(-1) });
                        else if (itemDef.type === 'seed' && !cell.floor && !cell.item) await updateDoc(roomRef, { [`${path}.item`]: selectedItem, [`${path}.stage`]: 0, [`${path}.plantedAt`]: new Date().toISOString(), [`inventory.${selectedItem}`]: increment(-1) });
                        else if (itemDef.type === 'deco' && !cell.item) await updateDoc(roomRef, { [`${path}.item`]: selectedItem, [`inventory.${selectedItem}`]: increment(-1) });
                        
                        if (invCount - 1 <= 0) setSelectedItem(null);
                    }
                    return;
                }

                if (cell.item) {
                    const itemDef = ITEMS[cell.item];
                    if (cell.grown) {
                         await updateDoc(roomRef, { [`${path}.item`]: deleteField(), [`${path}.stage`]: deleteField(), [`${path}.grown`]: deleteField(), gems: increment(itemDef.reward || 0) });
                    } else if (itemDef.type === 'seed') {
                        const now = Date.now();
                        const lastWatered = cell.lastWatered ? new Date(cell.lastWatered).getTime() : 0;
                        if (now - lastWatered > WATER_COOLDOWN) {
                             const newStage = (cell.stage || 0) + 1;
                             await updateDoc(roomRef, { [`${path}.stage`]: newStage, [`${path}.grown`]: newStage >= itemDef.stages, [`${path}.lastWatered`]: new Date().toISOString() });
                        }
                    }
                }
            };

            const createTask = async () => {
                if (!newTaskTitle.trim()) return;
                await updateDoc(doc(db, 'rooms', roomCode), { tasks: arrayUnion({ id: Date.now().toString(), title: newTaskTitle, reward: 15, done: false }) });
                setTaskModalOpen(false); setNewTaskTitle("");
            };

            const toggleTask = async (task) => {
                if (isSpectator) return;
                if (!task.done) await updateDoc(doc(db, 'rooms', roomCode), { tasks: arrayRemove(task), coins: increment(task.reward) });
            };

            const buy = async (id, isGarden) => {
                if (isSpectator) return;
                if(isGarden) {
                    const g = GARDEN_UPGRADES.find(x => x.id === id);
                    if(roomData.gems >= g.price) {
                        await updateDoc(doc(db, 'rooms', roomCode), { gems: increment(-g.price), unlockedGardens: arrayUnion(id), [`gardens.${id}`]: {} });
                    }
                } else {
                    const item = ITEMS[id];
                    if (roomData.coins >= item.price) {
                        await updateDoc(doc(db, 'rooms', roomCode), { coins: increment(-item.price), [`inventory.${id}`]: increment(1) });
                    }
                }
            };

            if (!roomData) return <div className="h-full flex items-center justify-center">Lade Garten...</div>;

            return (
                <div className={`flex h-full bg-slate-100 overflow-hidden md:max-w-7xl md:mx-auto md:my-8 md:rounded-3xl md:shadow-2xl md:border ${isSpectator ? 'border-purple-300 ring-4 ring-purple-100' : 'border-slate-200'}`}>
                    
                    {/* NAV (Hidden if Spectator on mobile, Simplified on Desktop) */}
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t z-40 flex justify-around p-2 pb-safe md:relative md:w-64 md:flex-col md:justify-start md:border-t-0 md:border-r md:p-6 md:gap-4">
                        <div className="hidden md:block mb-8">
                            <h1 className="text-2xl font-bold text-green-600 flex items-center gap-2"><i data-lucide="sprout"></i> DuoBloom</h1>
                            {isSpectator && <div className="bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded mt-2 font-bold uppercase text-center">Zuschauer Modus</div>}
                        </div>
                        
                        <button onClick={() => setTab('garden')} className={`p-3 rounded-xl flex md:flex-row flex-col items-center gap-3 transition-all ${tab === 'garden' ? 'bg-green-50 text-green-600 font-bold' : 'text-gray-400 hover:bg-gray-50'}`}>
                            <i data-lucide="flower-2"></i> <span className="text-[10px] md:text-sm">Garten</span>
                        </button>
                        
                        {!isSpectator && (
                            <>
                            <button onClick={() => setTab('tasks')} className={`p-3 rounded-xl flex md:flex-row flex-col items-center gap-3 transition-all ${tab === 'tasks' ? 'bg-blue-50 text-blue-600 font-bold' : 'text-gray-400 hover:bg-gray-50'}`}>
                                <i data-lucide="check-square"></i> <span className="text-[10px] md:text-sm">Aufgaben</span>
                            </button>
                            <button onClick={() => setTab('shop')} className={`p-3 rounded-xl flex md:flex-row flex-col items-center gap-3 transition-all ${tab === 'shop' ? 'bg-orange-50 text-orange-600 font-bold' : 'text-gray-400 hover:bg-gray-50'}`}>
                                <i data-lucide="shopping-cart"></i> <span className="text-[10px] md:text-sm">Shop</span>
                            </button>
                            </>
                        )}
                        
                        <div className="md:mt-auto pt-4 border-t md:border-t-0 flex-1 md:flex-none flex justify-center md:block">
                            <button onClick={onLeave} className="w-full text-left p-3 rounded-xl text-gray-600 hover:bg-red-50 hover:text-red-600 flex md:flex-row flex-col items-center gap-3 font-medium">
                                <i data-lucide="log-out"></i> <span className="text-[10px] md:text-sm">{isSpectator ? 'Zur√ºck' : 'Verlassen'}</span>
                            </button>
                        </div>
                    </nav>

                    {/* MAIN */}
                    <main className="flex-1 overflow-y-auto bg-[#eefcf3] relative pb-20 md:pb-0">
                        
                        {/* HEADER */}
                        <header className={`sticky top-0 backdrop-blur-md p-4 shadow-sm z-30 flex justify-between items-center px-6 ${isSpectator ? 'bg-purple-50/90' : 'bg-white/90'}`}>
                            <div className="flex flex-col">
                                {isEditingName && !isSpectator ? (
                                    <div className="flex items-center gap-2">
                                        <input autoFocus value={tempName} onChange={e => setTempName(e.target.value)} className="border rounded px-2 py-1 text-sm" placeholder="Name" />
                                        <button onClick={updateName} className="bg-green-500 text-white rounded p-1"><i data-lucide="check" size={16}></i></button>
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-2 group cursor-pointer" onClick={() => { if(!isSpectator){ setTempName(roomData.roomName || "Unbenannter Garten"); setIsEditingName(true); }}}>
                                        <span className="font-bold text-gray-700 truncate max-w-[150px] md:max-w-none text-lg">{roomData.roomName || "Unbenannter Garten"}</span>
                                        {!isSpectator && <i data-lucide="pencil" size={14} className="text-gray-300 group-hover:text-gray-500"></i>}
                                    </div>
                                )}
                                <span className="text-[10px] text-gray-400 font-mono">
                                    {isSpectator ? `Besuche: ${roomCode}` : `Code: ${roomCode}`}
                                </span>
                            </div>
                            
                            <div className="flex gap-4 ml-auto items-center">
                                {isSpectator && (
                                    <button onClick={handleLike} className={`flex items-center gap-2 px-3 py-1 rounded-full text-sm font-bold transition-all ${hasLiked ? 'bg-red-100 text-red-500' : 'bg-white border hover:bg-red-50 text-gray-500'}`}>
                                        <i data-lucide="heart" className={hasLiked ? "fill-red-500" : ""}></i> {roomData.likes || 0}
                                    </button>
                                )}
                                {!isSpectator && (
                                    <>
                                    <div className="flex flex-col items-end">
                                        <span className="text-xs text-gray-400 font-bold uppercase">M√ºnzen</span>
                                        <span className="font-bold text-yellow-600 text-lg flex items-center gap-1">üí∞ {roomData.coins}</span>
                                    </div>
                                    <div className="flex flex-col items-end">
                                        <span className="text-xs text-gray-400 font-bold uppercase">Gems</span>
                                        <span className="font-bold text-purple-600 text-lg flex items-center gap-1">üíé {roomData.gems}</span>
                                    </div>
                                    </>
                                )}
                            </div>
                        </header>

                        {/* GARDEN */}
                        {tab === 'garden' && (
                            <div className="p-4 md:p-8 flex flex-col items-center">
                                {/* Garden Selector */}
                                <div className="flex gap-2 mb-4 overflow-x-auto w-full justify-center">
                                    {GARDEN_UPGRADES.map(g => {
                                        const owned = roomData.unlockedGardens?.includes(g.id);
                                        if(!owned) return null;
                                        return (
                                            <button key={g.id} onClick={() => setActiveGardenIdx(g.id)} 
                                                className={`px-4 py-1 rounded-full text-sm font-bold border ${activeGardenIdx === g.id ? 'bg-green-500 text-white border-green-500' : 'bg-white text-green-700 border-green-200'}`}>
                                                {g.name}
                                            </button>
                                        )
                                    })}
                                </div>

                                {/* Grid */}
                                <div className="bg-[#5c4033] p-4 rounded-xl shadow-2xl relative inline-block">
                                    <div className="grid grid-cols-5 gap-0 border-2 border-[#3e2b22]">
                                        {Array.from({ length: 25 }).map((_, i) => {
                                            const key = `${i % 5},${Math.floor(i / 5)}`;
                                            const cell = (roomData.gardens[activeGardenIdx] || {})[key] || {};
                                            const floorItem = cell.floor ? ITEMS[cell.floor] : null;
                                            const objectItem = cell.item ? ITEMS[cell.item] : null;

                                            return (
                                                <div key={key} onClick={() => handleGridClick(key)}
                                                    className={`w-14 h-14 md:w-20 md:h-20 relative ${!isSpectator && 'cursor-pointer'} ${floorItem ? floorItem.css : 'bg-[#8fbc8f] border border-black/5'}`}
                                                >
                                                    {objectItem && (
                                                        <div className="absolute inset-0 flex items-center justify-center z-10 hover:scale-110 transition-transform">
                                                            {cell.grown || objectItem.type === 'deco' 
                                                                ? <span className="text-3xl md:text-4xl drop-shadow-md">{objectItem.icon}</span>
                                                                : <div className="flex flex-col items-center"><span className="text-xl">{objectItem.icon}</span><div className="w-8 h-1 bg-black/20 rounded-full mt-1 overflow-hidden"><div className="h-full bg-blue-500 transition-all" style={{width: `${(cell.stage/objectItem.stages)*100}%`}} /></div></div>
                                                            }
                                                        </div>
                                                    )}
                                                    {selectedItem && !objectItem && !floorItem && <div className="absolute inset-0 hover:bg-white/20" />}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* Inventory (Hidden for Spectator) */}
                                {!isSpectator && (
                                    <div className="mt-8 w-full max-w-2xl bg-white p-4 rounded-2xl shadow-lg border border-gray-100">
                                        <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">Werkzeugkasten</h3>
                                        <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                                            {Object.entries(roomData.inventory).map(([id, count]) => {
                                                if (count <= 0) return null;
                                                return (
                                                    <button key={id} onClick={() => setSelectedItem(selectedItem === id ? null : id)}
                                                        className={`flex-shrink-0 flex flex-col items-center p-3 rounded-xl border-2 transition-all min-w-[80px] ${selectedItem === id ? 'border-blue-500 bg-blue-50 shadow-md transform -translate-y-1' : 'border-gray-100 hover:bg-gray-50'}`}>
                                                        <span className="text-2xl mb-1">{ITEMS[id].icon}</span>
                                                        <span className="text-xs font-bold text-gray-600">{count}x</span>
                                                    </button>
                                                )
                                            })}
                                            {Object.values(roomData.inventory).every(c => c <= 0) && <div className="text-gray-400 text-sm italic">Leer. Geh zum Shop!</div>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* TASKS (Read Only for Spectator, or Hidden) */}
                        {tab === 'tasks' && !isSpectator && (
                            <div className="p-6 md:max-w-3xl md:mx-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-700">Aufgaben</h2>
                                    <button onClick={() => setTaskModalOpen(true)} className="bg-blue-500 text-white px-4 py-2 rounded-xl font-bold shadow-lg flex items-center gap-2"><i data-lucide="plus"></i> Neu</button>
                                </div>
                                <div className="space-y-3">
                                    {roomData.tasks.filter(t => !t.done).map(task => (
                                        <div key={task.id} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-lg text-gray-800">{task.title}</div>
                                                <div className="text-xs text-green-600 font-bold mt-1">+{task.reward} M√ºnzen</div>
                                            </div>
                                            <button onClick={() => toggleTask(task)} className="w-8 h-8 rounded-full border-2 border-gray-300 hover:border-green-500 hover:bg-green-50 flex items-center justify-center transition-colors"><i data-lucide="check" className="text-transparent hover:text-green-500 w-4 h-4"></i></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* SHOP */}
                        {tab === 'shop' && !isSpectator && (
                            <div className="p-6 md:max-w-4xl md:mx-auto pb-24">
                                <h3 className="font-bold text-xl text-purple-700 mb-4 flex items-center gap-2"><i data-lucide="castle"></i> Immobilien (Gems)</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                                    {GARDEN_UPGRADES.filter(g => g.id > 0).map(g => {
                                        const owned = roomData.unlockedGardens?.includes(g.id);
                                        return (
                                            <div key={g.id} className={`p-4 rounded-2xl border-2 flex flex-col items-center ${owned ? 'bg-gray-50 border-gray-200' : 'bg-purple-50 border-purple-200'}`}>
                                                <div className="text-3xl mb-2">üèûÔ∏è</div>
                                                <div className="font-bold">{g.name}</div>
                                                <button onClick={() => !owned && buy(g.id, true)} disabled={owned || roomData.gems < g.price} 
                                                    className={`mt-2 w-full py-2 rounded-xl text-sm font-bold ${owned ? 'text-gray-400 bg-gray-200' : 'bg-purple-600 text-white'}`}>
                                                    {owned ? 'Gekauft' : `${g.price} üíé`}
                                                </button>
                                            </div>
                                        )
                                    })}
                                </div>

                                <h3 className="font-bold text-xl text-orange-600 mb-4 flex items-center gap-2"><i data-lucide="store"></i> Markt (M√ºnzen)</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {Object.values(ITEMS).map(item => (
                                        <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center">
                                            <div className={`text-4xl mb-3 mt-2 ${item.css ? item.css + ' w-12 h-12 rounded flex items-center justify-center' : ''}`}>{item.icon}</div>
                                            <h3 className="font-bold text-gray-700 text-center text-sm">{item.name}</h3>
                                            <button onClick={() => buy(item.id, false)} disabled={roomData.coins < item.price}
                                                className={`mt-2 w-full py-2 rounded-xl text-sm font-bold transition-all ${roomData.coins >= item.price ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-400'}`}>
                                                {item.price} üí∞
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* MODALS */}
                    {isTaskModalOpen && (
                        <Modal title="Neue Aufgabe" onClose={() => setTaskModalOpen(false)}>
                            <div className="space-y-4">
                                <input value={newTaskTitle} onChange={e => setNewTaskTitle(e.target.value)} placeholder="Titel..." className="w-full border rounded-xl p-3 outline-none focus:ring-2 ring-blue-500" />
                                <button onClick={createTask} className="w-full bg-blue-500 text-white font-bold py-3 rounded-xl">Erstellen</button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const CommunityList = ({ onVisit, onBack }) => {
            const [list, setList] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const fetchG = async () => {
                    try {
                        const q = query(collection(db, 'rooms'), limit(50));
                        const snap = await getDocs(q);
                        const sorted = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.likes||0) - (a.likes||0));
                        setList(sorted);
                    } catch(e) { console.error(e); }
                    setLoading(false);
                };
                fetchG();
            }, []);

            return (
                <div className="h-full bg-slate-50 flex flex-col md:max-w-4xl md:mx-auto md:my-8 md:rounded-3xl shadow-xl overflow-hidden">
                    <div className="p-6 bg-white shadow-sm flex items-center gap-4">
                        <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h2 className="text-2xl font-bold text-gray-800">Community G√§rten</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-3">
                        {loading && <div>Lade Liste...</div>}
                        {list.map(g => (
                            <div key={g.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition-shadow">
                                <div>
                                    <div className="font-bold text-lg text-gray-800">{g.roomName || "Unbenannter Garten"}</div>
                                    <div className="text-sm text-gray-500 flex gap-3">
                                        <span className="text-red-500 flex items-center gap-1"><i data-lucide="heart" size={12}></i> {g.likes||0}</span>
                                        <span>Level {g.unlockedGardens?.length || 1}</span>
                                    </div>
                                </div>
                                <button onClick={() => onVisit(g.id)} className="bg-purple-100 text-purple-700 px-4 py-2 rounded-xl font-bold hover:bg-purple-200">Besuchen</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('loading'); // loading, login, menu, game, community, spectator
            const [roomCode, setRoomCode] = React.useState(null);
            const [spectateCode, setSpectateCode] = React.useState(null);

            React.useEffect(() => {
                if(!auth) return;
                const unsub = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        // Only fetch last room if we are not already in a view
                        if(view === 'loading') {
                            const userSnap = await getDoc(doc(db, 'users', u.uid));
                            if(userSnap.exists() && userSnap.data().lastRoom) setRoomCode(userSnap.data().lastRoom);
                            setView('menu');
                        }
                    } else {
                        setView('login');
                    }
                });
                return () => unsub();
            }, []);

            const handleAction = (action, code) => {
                if (action === 'resume') setView('game');
                else if (action === 'create') {
                    const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    setRoomCode(newCode);
                    updateDoc(doc(db, 'users', user.uid), { lastRoom: newCode }, { merge: true });
                    setView('game');
                } else if (action === 'join') {
                    setRoomCode(code);
                    updateDoc(doc(db, 'users', user.uid), { lastRoom: code }, { merge: true });
                    setView('game');
                } else if (action === 'community') {
                    setView('community');
                }
            };

            if (view === 'loading') return <div className="h-full flex items-center justify-center animate-pulse text-green-600 font-bold">Lade DuoBloom...</div>;

            if (view === 'login') return (
                <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-green-400 to-teal-500 text-white text-center">
                    <h1 className="text-6xl font-bold mb-4 drop-shadow-md">DuoBloom</h1>
                    <button onClick={() => signInWithPopup(auth, new GoogleAuthProvider())} className="bg-white text-green-600 px-8 py-4 rounded-2xl font-bold text-lg shadow-xl hover:scale-105 transition-transform flex items-center gap-3">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6" /> Los geht's
                    </button>
                </div>
            );

            if (view === 'community') return <CommunityList onVisit={(id) => { setSpectateCode(id); setView('spectator'); }} onBack={() => setView('menu')} />;
            if (view === 'spectator') return <GameApp user={user} roomCode={spectateCode} isSpectator={true} onLeave={() => setView('community')} />;
            if (view === 'menu') return <MainMenu user={user} currentRoom={roomCode} onAction={handleAction} />;
            if (view === 'game') return <GameApp user={user} roomCode={roomCode} isSpectator={false} onLeave={() => setView('menu')} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


