<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoBloom 15.0</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4ade80">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding:20px; color:#b91c1c; font-family:sans-serif; text-align:center; background:#fef2f2; height:100vh; display:flex; flex-direction:column; justify-content:center;">
                        <h2 style="font-size:24px; font-weight:bold; margin-bottom:10px;">Start-Fehler!</h2>
                        <p style="background:white; padding:10px; border-radius:8px; border:1px solid #fca5a5;">${msg}</p>
                        <p style="font-size:12px; color:gray; margin-top:10px;">Zeile: ${line}</p>
                        <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#ef4444; color:white; border:none; border-radius:8px;">Neu laden</button>
                    </div>
                `;
            }
            return false;
        };
    </script>

    <style>
        body { height: 100dvh; width: 100%; touch-action: manipulation; -webkit-tap-highlight-color: transparent; overflow: hidden; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .texture-stone { background-color: #d1d5db; background-image: radial-gradient(circle, #9ca3af 20%, transparent 20%), radial-gradient(circle, #9ca3af 20%, transparent 20%); background-size: 10px 10px; background-position: 0 0, 5px 5px; border: 1px solid #9ca3af; }
        .texture-wood { background-color: #78350f; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.1) 5px, rgba(255,255,255,0.1) 10px); border: 1px solid #451a03; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <div id="root" class="h-full w-full"></div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }
    </script>

    <script type="text/babel" data-type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, getDoc, getDocs, arrayUnion, arrayRemove, increment, deleteField, query, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDqEDD2Hds_pX5phI5cZKU3Q-mRtQxTZDg",
            authDomain: "duobloom-a9b7b.firebaseapp.com",
            projectId: "duobloom-a9b7b",
            storageBucket: "duobloom-a9b7b.firebasestorage.app",
            messagingSenderId: "118209789780",
            appId: "1:118209789780:web:ce2563e693a76f09a7d2c1",
            measurementId: "G-Z0W0LK6D88"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Init Error", e); }

        const WATER_COOLDOWN = 6 * 60 * 60 * 1000; 
        const GARDEN_BG = "assets/gbg.png"; 

        const ITEMS = {
            carrot_seed: { id: 'carrot_seed', name: 'Karotte', type: 'seed', price: 20, img: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Food/Carrot.png', icon: 'ðŸ¥•', growsInto: 'carrot', stages: 3, reward: 10 },
            sunflower_seed: { id: 'sunflower_seed', name: 'Sonnenblume', type: 'seed', price: 60, img: 'assets/sunflower.png', icon: 'ðŸŒ»', growsInto: 'sunflower', stages: 4, reward: 20 },
            forgetmenot_seed: { id: 'forgetmenot_seed', name: 'Vergissmeinnicht', type: 'seed', price: 100, img: 'assets/forgetmenot.png', icon: 'ðŸª»', growsInto: 'forgetmenot', stages: 6, reward: 50 },
            stone_floor: { id: 'stone_floor', name: 'Steinweg', type: 'floor', price: 10, css: 'texture-stone', icon: 'ðŸª¨' },
            wood_floor: { id: 'wood_floor', name: 'Holzboden', type: 'floor', price: 25, css: 'texture-wood', icon: 'ðŸªµ' },
            fence: { id: 'fence', name: 'Zaun', type: 'deco', price: 15, img: 'assets/fence.png', icon: 'ðŸš§' },
            bench: { id: 'bench', name: 'Bank', type: 'deco', price: 150, img: 'assets/bench.png', icon: 'ðŸª‘' },
            gnome: { id: 'gnome', name: 'Zwerg', type: 'deco', price: 250, img: 'assets/gnome.png', icon: 'ðŸŽ…' },
        };

        const GARDEN_UPGRADES = [
            { id: 0, name: "Start-Garten", price: 0 },
            { id: 1, name: "Hinterhof", price: 200 },
            { id: 2, name: "Waldlichtung", price: 650 },
        ];

        // --- 1. BASIC COMPONENTS ---

        const Icon = ({ name, size = 24, className = "" }) => {
            const ref = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide && ref.current) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    if(className) i.setAttribute('class', className);
                    ref.current.innerHTML = '';
                    ref.current.appendChild(i);
                    try { window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className } }); } catch(e){}
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }} />;
        };

        const ItemDisplay = ({ item, className = "" }) => {
            const [hasError, setHasError] = React.useState(false);
            if (!item) return null;
            if (item.img && !hasError) {
                return <img src={item.img} alt={item.name} className={`${className} object-contain drop-shadow-md`} onError={() => setHasError(true)} />;
            }
            return <span className={`flex items-center justify-center ${className} text-2xl`}>{item.icon || "â€¢"}</span>;
        };

        const getStreakStyle = (streak) => {
            if (streak === 0) return "from-slate-400 to-slate-500"; 
            if (streak < 3) return "from-blue-400 to-indigo-500"; 
            if (streak < 7) return "from-orange-500 to-red-500"; 
            if (streak < 14) return "from-purple-500 to-pink-500"; 
            if (streak < 30) return "from-cyan-400 to-blue-600"; 
            return "from-yellow-400 to-yellow-600 border-2 border-yellow-200"; 
        };

        // --- 2. GRID CELL (FORMATTED) ---

        const GridCell = ({ x, y, cell, handleGridClick, now }) => {
            const floorItem = cell.floor ? ITEMS[cell.floor] : null;
            const objectItem = cell.item ? ITEMS[cell.item] : null;
            let showTimer = false, timeLeftStr = "";

            if (objectItem && objectItem.type === 'seed' && !cell.grown) {
                const lastWatered = cell.lastWatered ? new Date(cell.lastWatered).getTime() : 0;
                const diff = now - lastWatered;
                if (diff < WATER_COOLDOWN) {
                    showTimer = true;
                    const ms = WATER_COOLDOWN - diff;
                    const h = Math.floor(ms / 3600000);
                    const m = Math.floor((ms % 3600000) / 60000);
                    timeLeftStr = `${h}h ${m}m`;
                }
            }

            return (
                <div onClick={() => handleGridClick(x, y)} className={`w-14 h-14 md:w-20 md:h-20 relative cursor-pointer ${floorItem ? floorItem.css : 'bg-white/10 border border-white/20'}`}>
                    {objectItem && (
                        <div className="absolute inset-0 flex items-center justify-center z-10 hover:scale-110 transition-transform">
                            {cell.grown || objectItem.type === 'deco' ? (
                                <ItemDisplay item={objectItem} className="w-10 h-10 md:w-16 md:h-16" />
                            ) : (
                                <div className="flex flex-col items-center relative">
                                    <ItemDisplay item={objectItem} className="w-8 h-8 md:w-12 md:h-12" />
                                    {showTimer ? (
                                        <div className="absolute -top-4 bg-black/70 text-white text-[8px] md:text-[10px] px-1.5 rounded-full backdrop-blur-sm pointer-events-none whitespace-nowrap">{timeLeftStr}</div>
                                    ) : (
                                        <div className="absolute -top-4 bg-blue-500 text-white text-[8px] px-1 rounded-full animate-bounce">GieÃŸen!</div>
                                    )}
                                    <div className="w-8 h-1 bg-black/20 rounded-full mt-1 overflow-hidden">
                                        <div className="h-full bg-blue-500 transition-all" style={{width: `${(cell.stage/objectItem.stages)*100}%`}} />
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {!objectItem && floorItem && <div className="absolute inset-0 hover:bg-white/20"></div>}
                </div>
            );
        };

        // --- 3. ERROR BOUNDARY ---

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            async handleReset() {
                if(confirm("Daten reparieren?")) {
                    try {
                        const roomRef = doc(db, 'rooms', this.props.roomCode);
                        await setDoc(roomRef, { tasks: [], inventory: {}, gardens: {0:{}} }, { merge: true });
                        window.location.reload();
                    } catch(e) { alert("Fehler: " + e.message); }
                }
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen flex flex-col items-center justify-center bg-red-50 p-6 text-center">
                            <h1 className="text-xl font-bold text-red-600 mb-2">Fehler aufgetreten ðŸ¥€</h1>
                            <p className="text-xs text-gray-500 mb-4 font-mono bg-white p-2 rounded border">{this.state.error?.message}</p>
                            <button onClick={() => window.location.reload()} className="bg-red-500 text-white px-6 py-3 rounded-xl font-bold mb-4">Neu laden</button>
                            <button onClick={() => this.handleReset()} className="mt-4 text-gray-400 underline text-xs">Notfall-Reparatur</button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        const Modal = ({ children, onClose, title }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-pop">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]">
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                        <button onClick={onClose}><Icon name="x" className="text-gray-500 hover:text-red-500" /></button>
                    </div>
                    <div className="p-4 overflow-y-auto">{children}</div>
                </div>
            </div>
        );

        const InstallHelpModal = ({ onClose }) => {
            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
            return (
                <Modal title="App installieren" onClose={onClose}>
                    <div className="space-y-4 text-center">
                        <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto text-green-600 mb-2"><Icon name="download" size={32} /></div>
                        {isIOS ? (
                            <ol className="text-left bg-gray-50 p-4 rounded-xl space-y-2 text-sm text-gray-700 border border-gray-200">
                                <li className="flex items-center gap-2">1. Tippe auf <strong className="text-blue-500 flex items-center gap-1">Teilen <Icon name="share" size={14}/></strong></li>
                                <li className="flex items-center gap-2">2. WÃ¤hle <strong>"Zum Home-Bildschirm"</strong></li>
                            </ol>
                        ) : (
                            <ol className="text-left bg-gray-50 p-4 rounded-xl space-y-2 text-sm text-gray-700 border border-gray-200">
                                <li className="flex items-center gap-2">1. Tippe auf das <strong>Browser-MenÃ¼</strong></li>
                                <li className="flex items-center gap-2">2. WÃ¤hle <strong>"App installieren"</strong></li>
                            </ol>
                        )}
                        <button onClick={onClose} className="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-xl mt-4">Verstanden</button>
                    </div>
                </Modal>
            );
        };

        // --- 4. HAUPT-SCREENS ---

        const MainMenu = ({ user, onAction, currentRoom }) => {
            const [joinCode, setJoinCode] = React.useState("");
            const [isCreating, setIsCreating] = React.useState(false);
            const [newGardenName, setNewGardenName] = React.useState("");
            const [isBusy, setIsBusy] = React.useState(false);
            const [installPrompt, setInstallPrompt] = React.useState(null);
            const [showInstallHelp, setShowInstallHelp] = React.useState(false);
            const [streak, setStreak] = React.useState(0);

            React.useEffect(() => { 
                if(window.lucide) try{window.lucide.createIcons();}catch(e){}
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setInstallPrompt(e); });
                if(currentRoom && db) {
                    getDoc(doc(db, 'rooms', currentRoom)).then(snap => {
                        if(snap.exists()) {
                            const data = snap.data();
                            const today = new Date().toISOString().split('T')[0];
                            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                            let s = data.currentStreak || 0;
                            const last = data.lastStreakDate;
                            if (last !== today && last !== yesterday) s = 0; 
                            setStreak(s);
                        }
                    }).catch(e => console.log("Streak error", e));
                }
            }, [currentRoom]);

            const handleCreate = async () => {
                if(!newGardenName.trim()) return alert("Bitte Namen eingeben");
                setIsBusy(true);
                await onAction('create', null, newGardenName);
                setIsBusy(false);
                setIsCreating(false);
            };

            const handleInstallClick = () => {
                if (installPrompt) {
                    installPrompt.prompt();
                    installPrompt.userChoice.then((res) => { if (res.outcome === 'accepted') setInstallPrompt(null); });
                } else { setShowInstallHelp(true); }
            };

            const streakBg = getStreakStyle(streak);

            return (
                <div className="h-full bg-slate-100 flex flex-col md:flex-row max-w-5xl mx-auto shadow-xl md:rounded-3xl md:my-8 overflow-hidden">
                    <div className="bg-white p-6 flex flex-col items-center border-b md:border-b-0 md:border-r border-gray-100 shadow-sm z-10 md:w-1/3 flex-shrink-0">
                        <div className="flex items-center gap-4 w-full md:flex-col">
                            <img src={user.photoURL} className="w-16 h-16 md:w-24 md:h-24 rounded-full border-4 border-green-500 shadow-lg" />
                            <div className="text-left md:text-center"><h1 className="text-xl md:text-2xl font-bold text-gray-800">{user.displayName}</h1><p className="text-xs text-gray-400">ID: {user.uid.slice(0,5)}</p></div>
                            <button onClick={() => auth.signOut()} className="ml-auto md:ml-0 md:mt-auto text-red-500 font-bold bg-red-50 p-2 rounded-lg"><Icon name="log-out" /></button>
                        </div>
                        <div className="hidden md:flex flex-col w-full space-y-2 mt-8">
                            <button onClick={() => onAction('community')} className="w-full bg-purple-50 border border-purple-200 p-3 rounded-xl text-purple-700 font-bold flex items-center justify-center gap-2 hover:bg-purple-100 transition-colors"><Icon name="globe" /> Community</button>
                            <button onClick={handleInstallClick} className="w-full bg-green-50 border border-green-200 p-3 rounded-xl text-green-700 font-bold flex items-center justify-center gap-2 hover:bg-green-100 transition-colors"><Icon name="plus-square" /> App installieren</button>
                        </div>
                    </div>
                    <div className="flex-1 bg-[#f8fafc] p-6 flex flex-col gap-6 overflow-y-auto">
                        <h2 className="text-2xl font-bold text-gray-700">Dashboard</h2>
                        
                        {currentRoom && (
                            <div className={`bg-gradient-to-r ${streakBg} w-full flex-shrink-0 p-6 rounded-3xl shadow-lg flex items-center justify-between text-white relative overflow-hidden mb-4 min-h-[120px] transition-all duration-500`}>
                                <div className="z-10 relative">
                                    <div className="text-xs font-bold uppercase tracking-wider opacity-90 mb-1">Dein Streak</div>
                                    <div className="text-4xl font-black flex items-baseline gap-2">{streak} <span className="text-base font-medium opacity-90">Tage</span></div>
                                    <div className="text-xs font-medium opacity-80 mt-1">{streak === 0 ? "Fang heute an!" : "Bleib dran! ðŸ”¥"}</div>
                                </div>
                                <div className="text-6xl animate-pulse z-10 drop-shadow-md transform translate-x-2">ðŸ”¥</div>
                                <div className="absolute -right-4 -bottom-8 bg-white opacity-10 w-32 h-32 rounded-full blur-2xl pointer-events-none"></div>
                            </div>
                        )}

                        {currentRoom ? (
                            <button onClick={() => onAction('resume', currentRoom)} className="bg-white border-2 border-green-500 text-green-600 p-6 rounded-2xl shadow-sm hover:bg-green-50 transition-all text-left flex items-center justify-between group flex-shrink-0">
                                <div><div className="text-green-800 text-sm font-bold uppercase mb-1">Letzte Sitzung</div><div className="text-2xl font-bold">WeitergÃ¤rtnern</div><div className="text-sm opacity-80 font-mono mt-1">Code: {currentRoom}</div></div>
                                <div className="bg-green-100 p-3 rounded-full"><Icon name="play" className="text-green-600" /></div>
                            </button>
                        ) : <div className="bg-gray-100 p-4 rounded-xl text-center text-gray-500 italic flex-shrink-0">Kein Garten besucht.</div>}
                        <hr className="border-gray-200" />
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20">
                            <button onClick={() => setIsCreating(true)} className="bg-white border-2 border-dashed border-gray-300 p-6 rounded-2xl text-gray-500 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center justify-center gap-2 h-32 flex-shrink-0"><div className="bg-blue-100 p-3 rounded-full text-blue-500"><Icon name="plus" /></div><span className="font-bold">Neuer Garten</span></button>
                            <div className="bg-white border border-gray-200 p-6 rounded-2xl flex flex-col justify-center h-32 flex-shrink-0"><label className="text-xs font-bold text-gray-400 uppercase mb-2">Code eingeben</label><div className="flex gap-2"><input value={joinCode} onChange={e => setJoinCode(e.target.value.toUpperCase())} placeholder="CODE" className="w-full bg-gray-100 rounded-lg px-3 py-2 font-bold uppercase focus:ring-2 ring-blue-500 outline-none" /><button onClick={() => joinCode && onAction('join', joinCode)} className="bg-blue-500 text-white px-3 rounded-lg font-bold hover:bg-blue-600 transition-colors"><Icon name="arrow-right" /></button></div></div>
                            <button onClick={() => onAction('community')} className="md:hidden bg-purple-50 border border-purple-200 p-4 rounded-2xl text-purple-700 font-bold flex items-center justify-center gap-2 hover:bg-purple-100 flex-shrink-0"><Icon name="globe" /> Community</button>
                            <button onClick={handleInstallClick} className="md:hidden bg-green-50 border border-green-200 p-4 rounded-2xl text-green-700 font-bold flex items-center justify-center gap-2 hover:bg-green-100 flex-shrink-0"><Icon name="plus-square" /> App installieren</button>
                        </div>
                    </div>
                    {isCreating && (
                        <Modal title="Garten benennen" onClose={() => !isBusy && setIsCreating(false)}><div className="space-y-4"><input autoFocus value={newGardenName} onChange={e => setNewGardenName(e.target.value)} placeholder="Name..." className="w-full border rounded-xl p-3 outline-none" disabled={isBusy} /><button onClick={handleCreate} disabled={isBusy} className={`w-full text-white font-bold py-3 rounded-xl ${isBusy ? 'bg-gray-400' : 'bg-green-500'}`}>{isBusy ? '...' : 'Erstellen'}</button></div></Modal>
                    )}
                    {showInstallHelp && <InstallHelpModal onClose={() => setShowInstallHelp(false)} />}
                </div>
            );
        };

        const CommunityList = ({ onVisit, onBack }) => {
            const [list, setList] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            React.useEffect(() => {
                const timer = setTimeout(() => { try { lucide.createIcons(); } catch(e) {} }, 100);
                const fetchG = async () => { try { const q = query(collection(db, 'rooms'), limit(50)); const snap = await getDocs(q); const sorted = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.likes||0) - (a.likes||0)); setList(sorted); } catch(e) { console.error(e); } setLoading(false); }; fetchG();
                return () => clearTimeout(timer);
            }, []);
            React.useEffect(() => { const t = setTimeout(() => { try { lucide.createIcons(); } catch(e) {} }, 100); return () => clearTimeout(t); }, [list]);
            return (
                <div className="h-full bg-slate-50 flex flex-col md:max-w-4xl md:mx-auto md:my-8 md:rounded-3xl shadow-xl overflow-hidden">
                    <div className="p-6 bg-white shadow-sm flex items-center gap-4"><button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-full"><Icon name="home" className="text-gray-600"/></button><h2 className="text-2xl font-bold text-gray-800">Community GÃ¤rten</h2></div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-3">
                        {loading && <div>Lade Liste...</div>}
                        {list.map(g => (<div key={g.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition-shadow"><div><div className="font-bold text-lg text-gray-800">{g.roomName || "Unbenannter Garten"}</div><div className="text-sm text-gray-500 flex gap-3"><span className="text-red-500 flex items-center gap-1"><Icon name="heart" size={12}/> {g.likes||0}</span><span>Level {g.unlockedGardens?.length || 1}</span></div></div><button onClick={() => onVisit(g.id)} className="bg-purple-100 text-purple-700 px-4 py-2 rounded-xl font-bold hover:bg-purple-200">Besuchen</button></div>))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('loading'); 
            const [roomCode, setRoomCode] = React.useState(null);
            const [spectateCode, setSpectateCode] = React.useState(null);

            React.useEffect(() => {
                if(!auth) { setView('login'); return; }
                const unsub = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        if(view === 'loading') { const userSnap = await getDoc(doc(db, 'users', u.uid)); if(userSnap.exists() && userSnap.data().lastRoom) setRoomCode(userSnap.data().lastRoom); setView('menu'); }
                    } else { setView('login'); }
                }); return () => unsub();
            }, []);

            const handleAction = async (action, code, name) => {
                if (action === 'resume') setView('game');
                else if (action === 'create') {
                    const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    await setDoc(doc(db, 'rooms', newCode), { roomName: name, coins: 50, gems: 0, tasks: [], inventory: {}, gardens: { 0: {} }, unlockedGardens: [0], likes: 0, createdAt: new Date().toISOString(), owner: user.uid });
                    setRoomCode(newCode);
                    await setDoc(doc(db, 'users', user.uid), { lastRoom: newCode }, { merge: true });
                    setView('game');
                } else if (action === 'join') {
                    setRoomCode(code);
                    await setDoc(doc(db, 'users', user.uid), { lastRoom: code }, { merge: true });
                    setView('game');
                } else if (action === 'community') setView('community');
            };

            // Safety timeout
            React.useEffect(() => {
                const t = setTimeout(() => { if(view === 'loading') setView('login'); }, 3000);
                return () => clearTimeout(t);
            }, [view]);

            if (view === 'loading') return <div className="h-full flex items-center justify-center animate-pulse text-green-600 font-bold">Lade DuoBloom...</div>;
            if (view === 'login') return <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-green-400 to-teal-500 text-white text-center"><h1 className="text-6xl font-bold mb-4 drop-shadow-md">DuoBloom</h1><button onClick={() => signInWithPopup(auth, new GoogleAuthProvider())} className="bg-white text-green-600 px-8 py-4 rounded-2xl font-bold text-lg shadow-xl hover:scale-105 transition-transform flex items-center gap-3"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6" /> Los geht's</button></div>;
            
            return (
                <ErrorBoundary roomCode={roomCode}>
                    {view === 'community' && <CommunityList onVisit={(id) => { setSpectateCode(id); setView('spectator'); }} onBack={() => setView('menu')} />}
                    {view === 'spectator' && <GameApp user={user} roomCode={spectateCode} isSpectator={true} onBackToMenu={() => setView('community')} />}
                    {view === 'menu' && <MainMenu user={user} currentRoom={roomCode} onAction={handleAction} />}
                    {view === 'game' && <GameApp user={user} roomCode={roomCode} isSpectator={false} onBackToMenu={() => setView('menu')} />}
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


