<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoBloom 20.0 (Octo-Brain Upgrade)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4ade80">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            const root = document.getElementById('root');
            if (root) root.innerHTML = '<div style="padding:20px; text-align:center; color:red;">Fehler: ' + msg + '</div>';
            return false;
        };
    </script>

    <style>
        body { height: 100dvh; width: 100%; touch-action: manipulation; -webkit-tap-highlight-color: transparent; overflow: hidden; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .texture-stone { background-color: #d1d5db; background-image: radial-gradient(circle, #9ca3af 20%, transparent 20%); background-size: 10px 10px; border: 1px solid #9ca3af; }
        .texture-wood { background-color: #78350f; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.1) 5px); border: 1px solid #451a03; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-bounce-slow { animation: bounce 3s infinite; }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        /* Kleiner Pfeil f√ºr Sprechblasen */
        .bubble-tail::after { content: ''; position: absolute; bottom: -8px; right: 20px; border-width: 8px 8px 0; border-style: solid; border-color: inherit transparent transparent transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, getDoc, getDocs, arrayUnion, arrayRemove, increment, deleteField, query, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // FIREBASE CONFIG (Deine Config)
        const firebaseConfig = {
            apiKey: "AIzaSyDqEDD2Hds_pX5phI5cZKU3Q-mRtQxTZDg",
            authDomain: "duobloom-a9b7b.firebaseapp.com",
            projectId: "duobloom-a9b7b",
            storageBucket: "duobloom-a9b7b.firebasestorage.app",
            messagingSenderId: "118209789780",
            appId: "1:118209789780:web:ce2563e693a76f09a7d2c1",
            measurementId: "G-Z0W0LK6D88"
        };

        let firebaseApp, auth, db;
        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
        } catch (e) { console.error("Init Error", e); }

        const WATER_COOLDOWN = 6 * 60 * 60 * 1000; 
        const GARDEN_BG = "assets/gbg.png"; 

        const ITEMS = {
            carrot_seed: { id: 'carrot_seed', name: 'Karotte', type: 'seed', price: 20, img: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Food/Carrot.png', icon: 'ü•ï', growsInto: 'carrot', stages: 3, reward: 10 },
            sunflower_seed: { id: 'sunflower_seed', name: 'Sonnenblume', type: 'seed', price: 60, img: 'assets/sunflower.png', icon: 'üåª', growsInto: 'sunflower', stages: 4, reward: 20 },
            forgetmenot_seed: { id: 'forgetmenot_seed', name: 'Vergissmeinnicht', type: 'seed', price: 100, img: 'assets/forgetmenot.png', icon: 'ü™ª', growsInto: 'forgetmenot', stages: 6, reward: 50 },
            stone_floor: { id: 'stone_floor', name: 'Steinweg', type: 'floor', price: 10, css: 'texture-stone', icon: 'ü™®' },
            wood_floor: { id: 'wood_floor', name: 'Holzboden', type: 'floor', price: 25, css: 'texture-wood', icon: 'ü™µ' },
            fence: { id: 'fence', name: 'Zaun', type: 'deco', price: 15, img: 'assets/fence.png', icon: 'üöß' },
            bench: { id: 'bench', name: 'Bank', type: 'deco', price: 150, img: 'assets/bench.png', icon: 'ü™ë' },
            gnome: { id: 'gnome', name: 'Zwerg', type: 'deco', price: 250, img: 'assets/gnome.png', icon: 'üéÖ' },
        };

        const GARDEN_UPGRADES = [
            { id: 0, name: "Start-Garten", price: 0 },
            { id: 1, name: "Hinterhof", price: 200 },
            { id: 2, name: "Waldlichtung", price: 650 },
        ];

        // --- COMPONENTS ---

        const Icon = ({ name, size = 24, className = "" }) => {
            const ref = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('class', className);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }} />;
        };

        const ItemDisplay = ({ item, className = "" }) => {
            if (!item) return null;
            if (item.img) return <img src={item.img} alt={item.name} className={`${className} object-contain drop-shadow-md`} />;
            return <span className={`flex items-center justify-center ${className} text-2xl`}>{item.icon || "‚Ä¢"}</span>;
        };

        // --- OCTO BRAIN 3.0 (SUPER SMART) ---
        const OCTO_BRAIN = {
            pick: function(arr) { return arr[Math.floor(Math.random() * arr.length)]; },

            // Bewertet den Garten von 0-10
            judgeGarden: function(ctx) {
                if (!ctx || !ctx.roomData) return { text: "Ich sehe nichts...", mood: 'confused' };
                const idx = ctx.activeGardenIdx || 0;
                const garden = ctx.roomData.gardens[idx] || {};
                
                let score = 5; 
                let plants = 0, thirsty = 0, variety = new Set();
                
                Object.values(garden).forEach(c => {
                    if (c.item && ITEMS[c.item]?.type === 'seed') {
                        plants++;
                        variety.add(c.item);
                        const lw = c.lastWatered ? new Date(c.lastWatered).getTime() : 0;
                        if (Date.now() - lw > WATER_COOLDOWN && !c.grown) { thirsty++; score -= 2; }
                    }
                    if (c.item && ITEMS[c.item]?.type === 'deco') score += 1;
                });

                if (plants === 0) score = 1;
                if (plants > 10) score += 1;
                if (variety.size > 2) score += 2;
                
                score = Math.max(0, Math.min(10, Math.round(score)));

                let text = `Garten-Note: ${score}/10. `;
                let mood = 'neutral';
                if (thirsty > 0) { text += `Punktabzug f√ºr ${thirsty} trockene Pflanzen! üí¶`; mood = 'panic'; }
                else if (score >= 9) { text += "Ein Paradies! üåü Ich bin stolz auf dich!"; mood = 'excited'; }
                else if (score <= 3) { text += "Das ist ja eine W√ºste! Pflanz was an! üåµ"; mood = 'sad'; }
                else { text += "Solide Arbeit. Aber da geht noch mehr Deko."; mood = 'smart'; }

                return { text, mood };
            },

            // Analysiert Inventar & Geld
            deepAnalyze: function(ctx) {
                const coins = ctx.roomData.coins || 0;
                const inv = ctx.roomData.inventory || {};
                const seeds = Object.keys(inv).filter(k => ITEMS[k]?.type === 'seed').reduce((a,b) => a+inv[b], 0);

                if (seeds > 5 && coins < 50) return { text: `Du bist pleite (${coins} üí∞), hast aber ${seeds} Samen. Pflanz sie an, um Geld zu verdienen! üìâ`, mood: 'smart' };
                if (coins > 500 && seeds === 0) return { text: `Dein Konto ist voll (${coins} üí∞), aber dein Rucksack leer. Geh shoppen! üõí`, mood: 'excited' };
                return { text: "Alles l√§uft effizient. Weiter so! üêô", mood: 'happy' };
            },

            greet: function(name) {
                const h = new Date().getHours();
                return { text: `Blub ${name || 'Chef'}! üêô ${h<12?'Morgen!':'Hi!'}`, mood: 'happy' };
            },

            think: function(input, ctx) {
                const text = input.toLowerCase();
                if (text.match(/(bewerten|rate|note|punkte)/)) return this.judgeGarden(ctx);
                if (text.match(/(tipp|hilfe|was tun|analyse)/)) return this.deepAnalyze(ctx);
                if (text.match(/(hallo|hi|moin)/)) return this.greet(ctx?.user?.displayName);
                if (text.match(/(durst|wasser)/)) {
                    const j = this.judgeGarden(ctx);
                    return j.mood === 'panic' ? {text:"JA! PANIK! GIE√üEN! üî•", mood:'panic'} : {text:"Alles feucht genug. üíß", mood:'happy'};
                }
                if (text.match(/(witz)/)) return {text: "Was ist gr√ºn und klopft an die T√ºr? Ein Klopfsalat! ü•¨", mood: 'excited'};
                
                return { text: "Frag mich 'Bewerte meinen Garten' oder 'Gib mir einen Tipp'. Ich sehe alles! üëÅÔ∏è", mood: 'confused' };
            },

            getIdleThought: function(ctx) {
                const r = Math.random();
                if(r < 0.3) return this.judgeGarden(ctx);
                if(r < 0.5) return this.deepAnalyze(ctx);
                return { text: "Ich berechne gerade die Photosynthese... ü§ì", mood: 'smart' };
            }
        };

        // --- OCTO BOT UI (MULTI BUBBLE & RESIZABLE) ---
        const OctoBot = ({ context, mode = 'mini' }) => {
            const [bubbles, setBubbles] = React.useState([]);
            const [input, setInput] = React.useState("");
            const [isOpen, setIsOpen] = React.useState(false);

            const speak = (res) => {
                if(!res) return;
                const newB = { id: Date.now(), text: res.text, mood: res.mood, emoji: getEmoji(res.mood) };
                setBubbles(prev => {
                    const list = [...prev, newB];
                    return list.slice(-3); // Max 3 Bubbles gleichzeitig
                });
                setTimeout(() => setBubbles(p => p.filter(b => b.id !== newB.id)), 10000); // 10s anzeigen
            };

            const getEmoji = (m) => m==='panic'?'üò±':m==='excited'?'ü§©':m==='sad'?'üò≠':m==='smart'?'ü§ì':'üêô';
            const getStyle = (m) => {
                if(m==='panic') return 'bg-red-500 text-white border-red-700 shadow-red-200';
                if(m==='excited') return 'bg-gradient-to-r from-yellow-200 to-orange-200 text-orange-900 border-orange-300';
                if(m==='sad') return 'bg-gray-700 text-gray-200 border-gray-900';
                if(m==='smart') return 'bg-indigo-100 text-indigo-900 border-indigo-300';
                return 'bg-white text-gray-800 border-gray-200';
            };

            const handleAsk = () => {
                if(!input.trim()) return;
                try { speak(OCTO_BRAIN.think(input, context)); } catch(e){}
                setInput(""); setIsOpen(false);
            };

            React.useEffect(() => {
                if(mode === 'full' && bubbles.length === 0) setTimeout(() => speak({text:"Willkommen in meinem B√ºro! üëî", mood:'smart'}), 500);
            }, [mode]);

            React.useEffect(() => {
                const i = setInterval(() => {
                    if(bubbles.length < 2 && Math.random() > 0.7 && !isOpen) {
                        const t = OCTO_BRAIN.getIdleThought(context);
                        if(t) speak(t);
                    }
                }, 15000);
                return () => clearInterval(i);
            }, [bubbles, isOpen, context]);

            // Container Klassen
            const wrapperClass = mode === 'full' 
                ? "relative w-full h-full flex flex-col items-center justify-center pointer-events-auto"
                : "absolute -bottom-6 -right-6 md:-right-16 md:bottom-0 z-50 flex flex-col items-end pointer-events-none";
            const imgSize = mode === 'full' ? "w-48 h-48 md:w-64 md:h-64" : "w-20 h-20";

            return (
                <div className={wrapperClass}>
                    <div className={`pointer-events-auto flex flex-col ${mode==='full'?'items-center':'items-end'}`}>
                        {/* BUBBLES STACK */}
                        <div className={`flex flex-col gap-2 mb-4 transition-all ${mode==='full'?'items-center w-full max-w-md':'items-end'}`}>
                            {bubbles.map(b => (
                                <div key={b.id} className={`${getStyle(b.mood)} p-3 md:p-4 rounded-2xl shadow-xl text-xs md:text-sm border-2 font-medium animate-pop relative max-w-[200px] md:max-w-[280px]`}>
                                    {b.text}
                                    <div className="absolute -bottom-2 -right-2 text-xl drop-shadow-md">{b.emoji}</div>
                                </div>
                            ))}
                        </div>

                        {/* INPUT */}
                        {isOpen && (
                            <div className="bg-white/90 backdrop-blur p-2 rounded-xl shadow-xl mb-4 flex gap-2 animate-pop border border-green-100 items-center z-50">
                                <input className="border rounded-lg px-2 py-1 text-sm w-40 outline-none" placeholder="Frag Octo..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleAsk()} autoFocus />
                                <button onClick={handleAsk} className="bg-green-500 text-white rounded p-1.5"><Icon name="send" size={16}/></button>
                            </div>
                        )}

                        {/* AVATAR BUTTON */}
                        <button onClick={() => { if(bubbles.length===0) speak({text:"Frag mich was! üêô", mood:'happy'}); setIsOpen(!isOpen); }} className="hover:scale-105 transition-transform active:scale-95 cursor-pointer z-10 relative">
                            <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Octopus.png" className={`${imgSize} drop-shadow-2xl animate-bounce-slow`} />
                        </button>
                    </div>
                </div>
            );
        };

        // --- GRID & GAME LOGIC ---

        const GridCell = ({ x, y, cell, handleGridClick, now }) => {
            const floorItem = cell.floor ? ITEMS[cell.floor] : null;
            const objectItem = cell.item ? ITEMS[cell.item] : null;
            let showTimer = false, timeLeftStr = "";

            if (objectItem && objectItem.type === 'seed' && !cell.grown) {
                const lastWatered = cell.lastWatered ? new Date(cell.lastWatered).getTime() : 0;
                const diff = now - lastWatered;
                if (diff < WATER_COOLDOWN) {
                    showTimer = true;
                    const ms = WATER_COOLDOWN - diff;
                    const h = Math.floor(ms / 3600000);
                    const m = Math.floor((ms % 3600000) / 60000);
                    timeLeftStr = h + "h " + m + "m";
                }
            }

            return (
                <div onClick={() => handleGridClick(x, y)} className={`w-14 h-14 md:w-20 md:h-20 relative cursor-pointer ${floorItem ? floorItem.css : 'bg-white/10 border border-white/20'}`}>
                    {objectItem && (
                        <div className="absolute inset-0 flex items-center justify-center z-10 hover:scale-110 transition-transform">
                            {cell.grown || objectItem.type === 'deco' ? (
                                <ItemDisplay item={objectItem} className="w-10 h-10 md:w-16 md:h-16" />
                            ) : (
                                <div className="flex flex-col items-center relative">
                                    <ItemDisplay item={objectItem} className="w-8 h-8 md:w-12 md:h-12" />
                                    {showTimer ? (
                                        <div className="absolute -top-4 bg-black/70 text-white text-[8px] px-1.5 rounded-full backdrop-blur-sm pointer-events-none">{timeLeftStr}</div>
                                    ) : (
                                        <div className="absolute -top-4 bg-blue-500 text-white text-[8px] px-1 rounded-full animate-bounce">Gie√üen!</div>
                                    )}
                                    <div className="w-8 h-1 bg-black/20 rounded-full mt-1 overflow-hidden">
                                        <div className="h-full bg-blue-500 transition-all" style={{width: `${(cell.stage/objectItem.stages)*100}%`}} />
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {!objectItem && floorItem && <div className="absolute inset-0 hover:bg-white/20"></div>}
                </div>
            );
        };

        const GameApp = ({ user, roomCode, isSpectator, onBackToMenu }) => {
            const [roomData, setRoomData] = React.useState(null);
            const [tab, setTab] = React.useState('garden');
            const [activeGardenIdx, setActiveGardenIdx] = React.useState(0);
            const [selectedItem, setSelectedItem] = React.useState(null);
            const [now, setNow] = React.useState(Date.now());

            React.useEffect(() => {
                if(!roomCode) return;
                const unsub = onSnapshot(doc(db, 'rooms', roomCode), (snap) => {
                    if (snap.exists()) setRoomData(snap.data());
                    else onBackToMenu();
                });
                return () => unsub();
            }, [roomCode]);

            React.useEffect(() => { const t = setInterval(() => setNow(Date.now()), 1000); return () => clearInterval(t); }, []);
            React.useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [tab, roomData]);

            const getGardens = () => roomData?.gardens || { 0: {} };
            const getCurrentGrid = () => (getGardens()[activeGardenIdx] || {});
            const getInventory = () => roomData?.inventory || {};
            
            const handleGridClick = async (x, y) => {
                if (isSpectator || !roomData) return;
                const key = `${x},${y}`;
                const cell = getCurrentGrid()[key] || {};
                const roomRef = doc(db, 'rooms', roomCode);
                const path = `gardens.${activeGardenIdx}.${key}`;

                if (selectedItem) {
                    const itemDef = ITEMS[selectedItem];
                    const invCount = getInventory()[selectedItem] || 0;
                    if (invCount > 0) {
                        if (itemDef.type === 'floor' && !cell.item) await updateDoc(roomRef, { [`${path}.floor`]: selectedItem, [`inventory.${selectedItem}`]: increment(-1) });
                        else if (itemDef.type === 'seed' && !cell.floor && !cell.item) await updateDoc(roomRef, { [`${path}.item`]: selectedItem, [`${path}.stage`]: 0, [`${path}.lastWatered`]: new Date().toISOString(), [`inventory.${selectedItem}`]: increment(-1) });
                        else if (itemDef.type === 'deco' && !cell.item) await updateDoc(roomRef, { [`${path}.item`]: selectedItem, [`inventory.${selectedItem}`]: increment(-1) });
                    }
                    return;
                }
                if (cell.item) {
                    const itemDef = ITEMS[cell.item];
                    if (cell.grown && itemDef.type === 'seed') await updateDoc(roomRef, { [`${path}.item`]: deleteField(), [`${path}.stage`]: deleteField(), [`${path}.grown`]: deleteField(), gems: increment(itemDef.reward || 0) });
                    else if (itemDef.type === 'seed') {
                        if (now - (cell.lastWatered ? new Date(cell.lastWatered).getTime() : 0) > WATER_COOLDOWN) {
                            const newStage = (cell.stage || 0) + 1;
                            await updateDoc(roomRef, { [`${path}.stage`]: newStage, [`${path}.grown`]: newStage >= itemDef.stages, [`${path}.lastWatered`]: new Date().toISOString() });
                        }
                    } else if (itemDef.type === 'deco') if(confirm("Einpacken?")) await updateDoc(roomRef, { [`${path}.item`]: deleteField(), [`inventory.${cell.item}`]: increment(1) });
                }
            };

            const buy = async (id, isGarden) => {
                if(isSpectator) return;
                if(isGarden) { const g = GARDEN_UPGRADES.find(x => x.id === id); if(roomData.gems >= g.price) await updateDoc(doc(db, 'rooms', roomCode), { gems: increment(-g.price), unlockedGardens: arrayUnion(id), [`gardens.${id}`]: {} }); }
                else { const item = ITEMS[id]; if (roomData.coins >= item.price) await updateDoc(doc(db, 'rooms', roomCode), { coins: increment(-item.price), [`inventory.${id}`]: increment(1) }); }
            };

            if (!roomData) return <div className="h-full flex items-center justify-center">Lade...</div>;

            const octoContext = { roomData, user, activeGardenIdx };

            return (
                <div className={`flex h-full bg-slate-100 overflow-hidden md:max-w-7xl md:mx-auto md:my-8 md:rounded-3xl md:shadow-2xl md:border ${isSpectator ? 'border-purple-300' : 'border-slate-200'}`}>
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t z-40 flex justify-around p-2 pb-safe md:relative md:w-64 md:flex-col md:justify-start md:border-t-0 md:border-r md:p-6 md:gap-4">
                        <div className="hidden md:block mb-8"><h1 className="text-2xl font-bold text-green-600 flex items-center gap-2"><Icon name="sprout"/> DuoBloom</h1></div>
                        <button onClick={() => setTab('garden')} className={`p-3 rounded-xl flex md:flex-col items-center gap-3 transition-all ${tab === 'garden' ? 'bg-green-50 text-green-600 font-bold' : 'text-gray-400'}`}><Icon name="flower-2"/><span className="text-[10px] md:text-sm">Garten</span></button>
                        <button onClick={() => setTab('octo')} className={`p-3 rounded-xl flex md:flex-col items-center gap-3 transition-all ${tab === 'octo' ? 'bg-purple-50 text-purple-600 font-bold' : 'text-gray-400'}`}><Icon name="message-circle"/><span className="text-[10px] md:text-sm">Octo</span></button>
                        {!isSpectator && <button onClick={() => setTab('shop')} className={`p-3 rounded-xl flex md:flex-col items-center gap-3 transition-all ${tab === 'shop' ? 'bg-orange-50 text-orange-600 font-bold' : 'text-gray-400'}`}><Icon name="shopping-cart"/><span className="text-[10px] md:text-sm">Shop</span></button>}
                    </nav>
                    <main className="flex-1 overflow-y-auto bg-[#eefcf3] relative pb-28 md:pb-0">
                        <header className="sticky top-0 bg-white/90 backdrop-blur-md p-4 shadow-sm z-30 flex justify-between items-center px-6">
                            <div className="flex items-center gap-4"><button onClick={onBackToMenu} className="bg-white border p-2 rounded-xl"><Icon name="home" className="text-gray-600"/></button><span className="font-bold text-gray-700">{roomData.roomName}</span></div>
                            <div className="flex gap-4 items-center">{!isSpectator && <><span className="font-bold text-yellow-600">üí∞ {roomData.coins}</span><span className="font-bold text-purple-600">üíé {roomData.gems}</span></>}</div>
                        </header>

                        {tab === 'garden' && (
                            <div className="p-4 md:p-8 flex flex-col items-center relative">
                                <div className="flex gap-2 mb-4 overflow-x-auto w-full justify-center">{GARDEN_UPGRADES.map(g => { const owned = (roomData.unlockedGardens || []).includes(g.id); if(!owned) return null; return <button key={g.id} onClick={() => setActiveGardenIdx(g.id)} className={`px-4 py-1 rounded-full text-sm font-bold border ${activeGardenIdx === g.id ? 'bg-green-500 text-white' : 'bg-white text-green-700'}`}>{g.name}</button> })}</div>
                                <div className="relative inline-block">
                                    <div className="p-4 rounded-xl shadow-2xl relative bg-cover bg-center" style={{ backgroundImage: `url(${GARDEN_BG})`, backgroundColor: '#5c4033' }}>
                                        <div className="grid grid-cols-5 gap-0 border-2 border-black/10 shadow-inner">
                                            {Array.from({ length: 25 }).map((_, i) => (
                                                <GridCell key={i} x={i%5} y={Math.floor(i/5)} cell={(getGardens()[activeGardenIdx] || {})[`${i%5},${Math.floor(i/5)}`] || {}} handleGridClick={handleGridClick} now={now} />
                                            ))}
                                        </div>
                                    </div>
                                    <OctoBot context={octoContext} mode="mini" />
                                </div>
                                {!isSpectator && <div className="mt-8 w-full max-w-2xl bg-white p-4 rounded-2xl shadow-lg border border-gray-100"><div className="flex gap-3 overflow-x-auto no-scrollbar">{Object.entries(getInventory()).map(([id, count]) => { if (count <= 0) return null; return <button key={id} onClick={() => setSelectedItem(selectedItem === id ? null : id)} className={`flex-shrink-0 flex flex-col items-center p-3 rounded-xl border-2 transition-all min-w-[80px] ${selectedItem === id ? 'border-blue-500 bg-blue-50' : 'border-gray-100'}`}><ItemDisplay item={ITEMS[id]} className="w-8 h-8" /><span className="text-xs font-bold text-gray-600">{count}x</span></button> })}</div></div>}
                            </div>
                        )}

                        {tab === 'octo' && (
                            <div className="h-full flex flex-col items-center justify-center p-6 bg-slate-50 relative overflow-hidden">
                                <div className="absolute top-10 left-10 text-9xl opacity-5 pointer-events-none">üåä</div>
                                <h2 className="text-3xl font-black text-slate-800 mb-8 z-10">Octo's B√ºro</h2>
                                <div className="flex-1 w-full flex items-center justify-center z-10"><OctoBot context={octoContext} mode="full" /></div>
                            </div>
                        )}

                        {tab === 'shop' && !isSpectator && (
                            <div className="p-6 md:max-w-4xl md:mx-auto pb-32">
                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">{GARDEN_UPGRADES.filter(g => g.id > 0).map(g => { const owned = (roomData.unlockedGardens || []).includes(g.id); return <div key={g.id} className="p-4 rounded-2xl border-2 flex flex-col items-center bg-purple-50 border-purple-200"><div className="font-bold">{g.name}</div><button onClick={() => !owned && buy(g.id, true)} disabled={owned || roomData.gems < g.price} className="mt-2 w-full py-2 rounded-xl text-sm font-bold bg-purple-600 text-white">{owned ? 'Besitz' : `${g.price} üíé`}</button></div> })}</div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">{Object.values(ITEMS).map(item => (<div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center"><ItemDisplay item={item} className="w-12 h-12 mb-2" /><h3 className="font-bold text-xs">{item.name}</h3><button onClick={() => buy(item.id, false)} disabled={roomData.coins < item.price} className="mt-2 w-full py-2 rounded-xl text-sm font-bold bg-orange-500 text-white">{item.price} üí∞</button></div>))}</div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState("loading");
            const [currentRoom, setCurrentRoom] = React.useState(null);

            React.useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    if (u) { setUser(u); setView("menu"); const l = localStorage.getItem("lastRoom"); if(l) setCurrentRoom(l); } 
                    else { setUser(null); setView("login"); }
                });
                return () => unsub();
            }, []);

            const handleAction = async (type, extra) => {
                if (type === 'create') {
                    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                    await setDoc(doc(db, 'rooms', code), { roomName: extra||"Garten", owner: user.uid, coins: 50, gems: 0, gardens: {0:{}}, unlockedGardens: [0], inventory: { carrot_seed: 2 } });
                    setCurrentRoom(code); localStorage.setItem("lastRoom", code); setView("game");
                } else if (type === 'join') {
                    const snap = await getDoc(doc(db, 'rooms', extra.toUpperCase()));
                    if (snap.exists()) { setCurrentRoom(extra.toUpperCase()); localStorage.setItem("lastRoom", extra.toUpperCase()); setView("game"); } else alert("N√∂.");
                }
            };

            if (view === "login") return <div className="h-full flex flex-col items-center justify-center p-6"><button onClick={() => signInWithPopup(auth, new GoogleAuthProvider())} className="bg-white border-2 px-8 py-4 rounded-2xl font-bold shadow-sm">Mit Google anmelden</button></div>;
            if (view === "loading") return <div className="h-full flex items-center justify-center">Lade...</div>;

            if (view === 'menu') return (
                <div className="h-full bg-slate-100 flex items-center justify-center p-6">
                    <div className="w-full max-w-md space-y-4">
                        <h1 className="text-2xl font-bold text-center">Hallo {user.displayName}</h1>
                        {currentRoom && <button onClick={() => setView('game')} className="w-full bg-green-500 text-white p-4 rounded-xl font-bold shadow-lg">Weiter: {currentRoom}</button>}
                        <button onClick={() => { const n = prompt("Name?"); if(n) handleAction('create', n); }} className="w-full bg-white border p-4 rounded-xl font-bold">Neuer Garten</button>
                        <button onClick={() => { const c = prompt("Code?"); if(c) handleAction('join', c); }} className="w-full bg-white border p-4 rounded-xl font-bold">Code eingeben</button>
                        <button onClick={() => auth.signOut()} className="w-full text-red-500 p-4">Abmelden</button>
                    </div>
                </div>
            );

            return <GameApp user={user} roomCode={currentRoom} isSpectator={false} onBackToMenu={() => setView('menu')} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
