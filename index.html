<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoBloom ðŸŒ·</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.2s ease-out; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-full overflow-hidden select-none">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, getDoc,
            arrayUnion, arrayRemove, increment, deleteField 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ==========================================
        // --- DEINE FIREBASE CONFIG HIER EINFÃœGEN ---
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDqEDD2Hds_pX5phI5cZKU3Q-mRtQxTZDg",
            authDomain: "duobloom-a9b7b.firebaseapp.com",
            projectId: "duobloom-a9b7b",
            storageBucket: "duobloom-a9b7b.firebasestorage.app",
            messagingSenderId: "118209789780",
            appId: "1:118209789780:web:ce2563e693a76f09a7d2c1",
            measurementId: "G-Z0W0LK6D88"
          };
        // ==========================================

        let app, auth, db;
        try {
            if (firebaseConfig.apiKey !== "HIER_API_KEY_EINFUEGEN") {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) { console.error(e); }

        const ITEMS = {
            carrot_seed: { id: 'carrot_seed', name: 'Karotte', type: 'seed', price: 20, icon: 'ðŸŒ±', growsInto: 'carrot', stages: 3, reward: 5 },
            rose_seed: { id: 'rose_seed', name: 'Rose', type: 'seed', price: 50, icon: 'ðŸŒ°', growsInto: 'rose', stages: 4, reward: 15 },
            tree_sapling: { id: 'tree_sapling', name: 'Baum', type: 'seed', price: 100, icon: 'ðŸŒ¿', growsInto: 'tree', stages: 5, reward: 30 },
            fence: { id: 'fence', name: 'Zaun', type: 'deco', price: 15, icon: 'fence' },
            gnome: { id: 'gnome', name: 'Zwerg', type: 'deco', price: 200, icon: 'gnome' },
        };

        const GROWN_ITEMS = {
            carrot: { name: 'Karotte', icon: 'ðŸ¥•' },
            rose: { name: 'Rose', icon: 'ðŸŒ¹' },
            tree: { name: 'Baum', icon: 'ðŸŒ³' },
            fence: { name: 'Zaun', icon: 'ðŸš§' },
            gnome: { name: 'Zwerg', icon: 'ðŸŽ…' },
        };

        // --- COMPONENTS ---

        const LoginScreen = ({ onLogin }) => {
            const login = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    // onLogin wird via onAuthStateChanged im Main App getriggert
                } catch (error) {
                    alert("Login Fehler: " + error.message);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center h-full p-6 bg-green-50">
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
                        <h1 className="text-4xl font-bold text-green-600 mb-2">DuoBloom ðŸŒ·</h1>
                        <p className="text-gray-500 mb-8">Euer gemeinsamer Garten.</p>
                        
                        <button onClick={login} className="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all shadow-sm">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6" />
                            Mit Google anmelden
                        </button>
                    </div>
                </div>
            );
        };

        const RoomSelectScreen = ({ onJoin, userName }) => {
            const [code, setCode] = React.useState('');
            
            const createNew = () => {
                const newCode = Math.random().toString(36).substring(2, 7).toUpperCase();
                onJoin(newCode);
            };

            return (
                <div className="flex flex-col items-center justify-center h-full p-6 bg-green-50">
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
                        <h2 className="text-xl font-bold text-gray-700 mb-1">Hallo, {userName}! ðŸ‘‹</h2>
                        <p className="text-gray-400 text-sm mb-6">Tritt einem Garten bei.</p>
                        
                        <button onClick={createNew} className="w-full bg-green-500 text-white font-bold py-3 rounded-xl mb-4 shadow-lg hover:bg-green-600">
                            Neuen Garten anlegen
                        </button>
                        
                        <div className="flex items-center gap-2 mb-4">
                            <hr className="flex-1" /><span className="text-gray-400 text-sm">ODER</span><hr className="flex-1" />
                        </div>

                        <div className="flex gap-2">
                            <input 
                                value={code} onChange={e => setCode(e.target.value.toUpperCase())}
                                placeholder="CODE EINGEBEN"
                                className="w-full border-2 border-gray-200 rounded-xl px-4 py-2 font-bold text-center tracking-widest uppercase focus:border-green-500 outline-none"
                            />
                            <button onClick={() => code && onJoin(code)} className="bg-blue-500 text-white px-4 rounded-xl font-bold">Go</button>
                        </div>
                        
                        <button onClick={() => auth.signOut()} className="mt-8 text-xs text-red-400 underline">Abmelden</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [room, setRoom] = React.useState(null);
            const [data, setData] = React.useState(null);
            const [tab, setTab] = React.useState('garden');
            const [selectedSeed, setSelectedSeed] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            // 1. Auth & Auto-Join Logic
            React.useEffect(() => {
                if (!auth) return;
                const unsub = onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    if (u) {
                        // Check if user has a saved room in their profile
                        const userRef = doc(db, 'users', u.uid);
                        const userSnap = await getDoc(userRef);
                        if (userSnap.exists() && userSnap.data().currentRoom) {
                            setRoom(userSnap.data().currentRoom);
                        }
                    } else {
                        setRoom(null);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            // 2. Room Data Sync
            React.useEffect(() => {
                if (!user || !room || !db) return;
                
                // Save room to user profile for next time
                setDoc(doc(db, 'users', user.uid), { currentRoom: room }, { merge: true });

                const unsub = onSnapshot(doc(db, 'rooms', room), (snap) => {
                    if (snap.exists()) {
                        setData(snap.data());
                    } else {
                        // Create new room
                        setDoc(doc(db, 'rooms', room), {
                            coins: 50, gems: 0,
                            tasks: [{ id: '1', title: 'Erste Aufgabe!', reward: 20, done: false }],
                            inventory: {}, grid: {},
                            createdAt: new Date().toISOString(),
                            owner: user.uid
                        });
                    }
                });
                return () => unsub();
            }, [user, room]);

            React.useEffect(() => { lucide.createIcons(); }, [data, tab]);

            // --- UI RENDER LOGIC ---
            if (!auth) return <div className="p-10 text-center text-red-500 font-bold">FEHLER: Du musst die Firebase Config im Code einfÃ¼gen!</div>;
            if (loading) return <div className="flex items-center justify-center h-full text-green-600 animate-pulse font-bold">Lade DuoBloom...</div>;
            if (!user) return <LoginScreen />;
            if (!room) return <RoomSelectScreen userName={user.displayName?.split(' ')[0] || 'GÃ¤rtner'} onJoin={setRoom} />;
            if (!data) return <div className="flex items-center justify-center h-full">Betrete Garten...</div>;

            // --- GAME ACTIONS ---
            const handleGridClick = async (key) => {
                const cell = data.grid[key];
                const roomRef = doc(db, 'rooms', room);

                if (cell && cell.grown) {
                    const item = ITEMS[cell.source];
                    await updateDoc(roomRef, { [`grid.${key}`]: deleteField(), gems: increment(item.reward || 0) });
                    return;
                }
                if (cell && !cell.grown && ITEMS[cell.source].type === 'seed') {
                    const item = ITEMS[cell.source];
                    const newStage = (cell.stage || 0) + 1;
                    await updateDoc(roomRef, { [`grid.${key}.stage`]: newStage, [`grid.${key}.grown`]: newStage >= item.stages });
                    return;
                }
                if (!cell && selectedSeed && (data.inventory[selectedSeed] || 0) > 0) {
                    const item = ITEMS[selectedSeed];
                    await updateDoc(roomRef, {
                        [`grid.${key}`]: { source: selectedSeed, stage: 0, grown: item.type === 'deco', plantedAt: new Date().toISOString() },
                        [`inventory.${selectedSeed}`]: increment(-1)
                    });
                    if (data.inventory[selectedSeed] <= 1) setSelectedSeed(null);
                }
            };

            const buy = async (id) => {
                const item = ITEMS[id];
                if (data.coins >= item.price) {
                    await updateDoc(doc(db, 'rooms', room), { coins: increment(-item.price), [`inventory.${id}`]: increment(1) });
                }
            };

            const addTask = async (e) => {
                e.preventDefault();
                const title = e.target.elements.title.value;
                if(!title) return;
                e.target.reset();
                await updateDoc(doc(db, 'rooms', room), { tasks: arrayUnion({ id: Date.now().toString(), title, reward: 15, done: false }) });
            };

            const finishTask = async (task) => {
                await updateDoc(doc(db, 'rooms', room), { tasks: arrayRemove(task), coins: increment(task.reward) });
            };

            const leaveGarden = () => {
                if(confirm("Garten verlassen und anderen Code eingeben?")) {
                    setRoom(null);
                    // Optional: Remove from user profile if you want strict logout from room
                    // updateDoc(doc(db, 'users', user.uid), { currentRoom: deleteField() });
                }
            }

            return (
                <div className="flex flex-col h-full max-w-md mx-auto bg-white shadow-2xl overflow-hidden relative">
                    <header className="bg-white p-3 shadow-sm z-10 flex justify-between items-center border-b">
                        <button onClick={leaveGarden} className="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-1 rounded hover:bg-red-100 hover:text-red-500 transition-colors" title="Garten verlassen">
                            {room} ðŸšª
                        </button>
                        <div className="flex gap-3">
                            <span className="flex items-center gap-1 text-yellow-600 font-bold bg-yellow-50 px-2 rounded-full text-sm">ðŸ’° {data.coins}</span>
                            <span className="flex items-center gap-1 text-purple-600 font-bold bg-purple-50 px-2 rounded-full text-sm">ðŸ’Ž {data.gems}</span>
                        </div>
                        <div className="w-8 h-8 rounded-full overflow-hidden border border-gray-200">
                             <img src={user.photoURL} alt="User" />
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto bg-slate-50 relative">
                        {tab === 'garden' && (
                            <div className="p-4 flex flex-col items-center min-h-full">
                                <div className="grid grid-cols-5 gap-2 bg-green-900/10 p-3 rounded-xl border-4 border-green-800/20 mb-20">
                                    {Array.from({ length: 25 }).map((_, i) => {
                                        const key = `${i % 5},${Math.floor(i / 5)}`;
                                        const cell = data.grid[key];
                                        const item = cell ? ITEMS[cell.source] : null;
                                        return (
                                            <div key={i} onClick={() => handleGridClick(key)}
                                                className={`w-12 h-12 sm:w-16 sm:h-16 rounded-lg flex items-center justify-center text-2xl cursor-pointer relative transition-all active:scale-90 ${cell ? 'bg-green-300' : 'bg-green-200 hover:bg-green-300'} ${selectedSeed && !cell ? 'animate-pulse ring-2 ring-blue-400' : ''}`}>
                                                {cell && (
                                                    <div className="w-full h-full flex items-center justify-center">
                                                        {cell.grown ? (
                                                            <span className="scale-125 drop-shadow">{GROWN_ITEMS[item.growsInto || item.id].icon}</span>
                                                        ) : (
                                                            <div className="flex flex-col items-center">
                                                                <span>{item.icon}</span>
                                                                <div className="absolute bottom-1 w-8 h-1 bg-gray-400 rounded-full overflow-hidden">
                                                                    <div className="h-full bg-blue-500 transition-all" style={{width: `${(cell.stage/item.stages)*100}%`}}></div>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="absolute bottom-4 left-4 right-4 bg-white p-2 rounded-2xl shadow-lg border border-gray-100 flex gap-2 overflow-x-auto no-scrollbar">
                                    {Object.entries(data.inventory).map(([id, count]) => {
                                        if (count <= 0) return null;
                                        return (
                                            <button key={id} onClick={() => setSelectedSeed(selectedSeed === id ? null : id)}
                                                className={`flex-shrink-0 flex flex-col items-center p-2 rounded-xl border-2 w-16 ${selectedSeed === id ? 'border-blue-500 bg-blue-50' : 'border-transparent'}`}>
                                                <span className="text-xl">{ITEMS[id].icon}</span>
                                                <span className="text-xs font-bold text-gray-600">x{count}</span>
                                            </button>
                                        );
                                    })}
                                    {Object.values(data.inventory).every(c => c <= 0) && <p className="text-xs text-gray-400 w-full text-center py-2">Leer... Ab in den Shop!</p>}
                                </div>
                            </div>
                        )}
                        {tab === 'tasks' && (
                            <div className="p-6">
                                <h2 className="text-xl font-bold mb-4 text-gray-700">Aufgaben</h2>
                                <form onSubmit={addTask} className="flex gap-2 mb-6">
                                    <input name="title" placeholder="Neue Aufgabe..." className="flex-1 border rounded-xl px-4 py-2 focus:ring-2 ring-blue-500 outline-none" autoComplete="off" />
                                    <button className="bg-blue-500 text-white px-4 rounded-xl font-bold">+</button>
                                </form>
                                <div className="space-y-3">
                                    {data.tasks.map(task => (
                                        <div key={task.id} className="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center">
                                            <span>{task.title}</span>
                                            <button onClick={() => finishTask(task)} className="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-sm font-bold hover:bg-green-500 hover:text-white transition-colors">+{task.reward} ðŸ’°</button>
                                        </div>
                                    ))}
                                    {data.tasks.length === 0 && <p className="text-center text-gray-400">Alles erledigt!</p>}
                                </div>
                            </div>
                        )}
                        {tab === 'shop' && (
                            <div className="p-6 grid grid-cols-2 gap-4 pb-20">
                                {Object.values(ITEMS).map(item => (
                                    <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border flex flex-col items-center relative">
                                        <span className="text-4xl mb-2">{item.icon}</span>
                                        <span className="font-bold">{item.name}</span>
                                        <span className="text-xs text-gray-400 mb-2">{item.type === 'seed' ? 'Pflanze' : 'Deko'}</span>
                                        <button onClick={() => buy(item.id)} disabled={data.coins < item.price}
                                            className={`w-full py-2 rounded-lg text-sm font-bold ${data.coins >= item.price ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-400'}`}>
                                            {item.price} ðŸ’°
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    <nav className="bg-white border-t p-2 flex justify-around pb-6">
                        <button onClick={() => setTab('garden')} className={`p-2 rounded-xl transition-colors ${tab === 'garden' ? 'text-green-600 bg-green-50' : 'text-gray-400'}`}><i data-lucide="sprout"></i></button>
                        <button onClick={() => setTab('tasks')} className={`p-2 rounded-xl transition-colors ${tab === 'tasks' ? 'text-blue-600 bg-blue-50' : 'text-gray-400'}`}><i data-lucide="check-circle-2"></i></button>
                        <button onClick={() => setTab('shop')} className={`p-2 rounded-xl transition-colors ${tab === 'shop' ? 'text-orange-600 bg-orange-50' : 'text-gray-400'}`}><i data-lucide="shopping-bag"></i></button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


