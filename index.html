<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoBloom 24.0 (Chatty AI)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4ade80">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = '<div style="padding:20px; color:#b91c1c; font-family:sans-serif; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; background:#fef2f2;">' +
                    '<h2 style="font-size:20px; font-weight:bold; margin-bottom:10px;">Start-Fehler!</h2>' +
                    '<p style="background:white; padding:15px; border-radius:8px; border:1px solid #fca5a5; font-family:monospace;">' + msg + '</p>' +
                    '<p style="font-size:12px; color:gray; margin-top:10px;">Zeile: ' + line + '</p>' +
                    '<button onclick="location.reload()" style="margin-top:20px; padding:12px 24px; background:#ef4444; color:white; border:none; border-radius:8px; font-weight:bold;">Neu laden</button>' +
                    '</div>';
            }
            return false;
        };
    </script>

    <style>
        body { height: 100dvh; width: 100%; touch-action: manipulation; -webkit-tap-highlight-color: transparent; overflow: hidden; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .texture-stone { background-color: #d1d5db; background-image: radial-gradient(circle, #9ca3af 20%, transparent 20%), radial-gradient(circle, #9ca3af 20%, transparent 20%); background-size: 10px 10px; background-position: 0 0, 5px 5px; border: 1px solid #9ca3af; }
        .texture-wood { background-color: #78350f; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.1) 5px, rgba(255,255,255,0.1) 10px); border: 1px solid #451a03; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        /* CHAT STYLES */
        .chat-container { display: flex; flex-direction: column; height: 100%; background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%); }
        .chat-bubble { max-width: 80%; padding: 12px 16px; border-radius: 18px; margin-bottom: 8px; font-size: 14px; line-height: 1.5; animation: pop 0.2s ease-out; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); word-wrap: break-word; }
        .chat-octo { background-color: white; color: #1f2937; border-bottom-left-radius: 4px; border: 1px solid #e5e7eb; margin-left: 8px; }
        .chat-user { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-bottom-right-radius: 4px; align-self: flex-end; margin-right: 8px; }
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background-color: #9ca3af; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, getDoc, getDocs, arrayUnion, arrayRemove, increment, deleteField, query, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDqEDD2Hds_pX5phI5cZKU3Q-mRtQxTZDg",
            authDomain: "duobloom-a9b7b.firebaseapp.com",
            projectId: "duobloom-a9b7b",
            storageBucket: "duobloom-a9b7b.firebasestorage.app",
            messagingSenderId: "118209789780",
            appId: "1:118209789780:web:ce2563e693a76f09a7d2c1",
            measurementId: "G-Z0W0LK6D88"
        };

        let firebaseApp, auth, db;
        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
        } catch (e) { console.error("Init Error", e); }

        const WATER_COOLDOWN = 6 * 60 * 60 * 1000; 
        const GARDEN_BG = "assets/gbg.png"; 

        const ITEMS = {
            carrot_seed: { id: 'carrot_seed', name: 'Karotte', type: 'seed', price: 20, img: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Food/Carrot.png', icon: 'ü•ï', growsInto: 'carrot', stages: 3, reward: 10 },
            sunflower_seed: { id: 'sunflower_seed', name: 'Sonnenblume', type: 'seed', price: 60, img: 'assets/sunflower.png', icon: 'üåª', growsInto: 'sunflower', stages: 4, reward: 20 },
            forgetmenot_seed: { id: 'forgetmenot_seed', name: 'Vergissmeinnicht', type: 'seed', price: 100, img: 'assets/forgetmenot.png', icon: 'ü™ª', growsInto: 'forgetmenot', stages: 6, reward: 50 },
            stone_floor: { id: 'stone_floor', name: 'Steinweg', type: 'floor', price: 10, css: 'texture-stone', icon: 'ü™®' },
            wood_floor: { id: 'wood_floor', name: 'Holzboden', type: 'floor', price: 25, css: 'texture-wood', icon: 'ü™µ' },
            fence: { id: 'fence', name: 'Zaun', type: 'deco', price: 15, img: 'assets/fence.png', icon: 'üöß' },
            bench: { id: 'bench', name: 'Bank', type: 'deco', price: 150, img: 'assets/bench.png', icon: 'ü™ë' },
            gnome: { id: 'gnome', name: 'Zwerg', type: 'deco', price: 250, img: 'assets/gnome.png', icon: 'üéÖ' },
        };

        const GARDEN_UPGRADES = [
            { id: 0, name: "Start-Garten", price: 0 },
            { id: 1, name: "Hinterhof", price: 200 },
            { id: 2, name: "Waldlichtung", price: 650 },
        ];

        // --- 1. BASIC COMPONENTS ---

        const Icon = ({ name, size = 24, className = "" }) => {
            const ref = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide && ref.current) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    if(className) i.setAttribute('class', className);
                    ref.current.innerHTML = '';
                    ref.current.appendChild(i);
                    try { window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className } }); } catch(e){}
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }} />;
        };

        const ItemDisplay = ({ item, className = "" }) => {
            const [hasError, setHasError] = React.useState(false);
            if (!item) return null;
            if (item.img && !hasError) {
                return <img src={item.img} alt={item.name} className={`${className} object-contain drop-shadow-md`} onError={() => setHasError(true)} />;
            }
            return <span className={`flex items-center justify-center ${className} text-2xl`}>{item.icon || "‚Ä¢"}</span>;
        };

        const getStreakStyle = (streak) => {
            if (streak === 0) return "from-slate-400 to-slate-500"; 
            if (streak < 3) return "from-blue-400 to-indigo-500"; 
            if (streak < 7) return "from-orange-500 to-red-500"; 
            if (streak < 14) return "from-purple-500 to-pink-500"; 
            if (streak < 30) return "from-cyan-400 to-blue-600"; 
            return "from-yellow-400 to-yellow-600 border-2 border-yellow-200"; 
        };

        // --- 2. ADVANCED OCTO BRAIN ---
        
        const OCTO_BRAIN = {
            memory: {
                lastTopic: null,
                userName: "G√§rtner"
            },

            getRandom: function(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            },

            greet: function(name) {
                const h = new Date().getHours();
                const timeGreeting = h < 12 ? "Guten Morgen" : h < 18 ? "Hallo" : "N'abend";
                this.memory.userName = name;
                return this.getRandom([
                    "Blub! " + timeGreeting + ", " + name + "! üêô Sch√∂n dich zu sehen!",
                    "Ahoi " + name + "! Bereit zum G√§rtnern? üåø",
                    "Blub blub! Ich bin bereit f√ºr deine Fragen! üåä"
                ]);
            },
            
            analyzeState: function(ctx) {
                if (!ctx || !ctx.roomData) return "Blub! Ich sortiere noch meine Tentakel... (Lade Daten)";
                
                const idx = ctx.activeGardenIdx || 0;
                const garden = (ctx.roomData.gardens && ctx.roomData.gardens[idx]) ? ctx.roomData.gardens[idx] : {};
                const coins = ctx.roomData.coins || 0;
                const tasks = ctx.tasks || [];
                const now = Date.now();
                
                let thirsty = 0;
                let ready = 0;
                let plantCount = 0;

                Object.values(garden).forEach(function(c) {
                    if(c.item && ITEMS[c.item] && ITEMS[c.item].type === 'seed') {
                        plantCount++;
                        if(c.grown) ready++;
                        else {
                            const lw = c.lastWatered ? new Date(c.lastWatered).getTime() : 0;
                            if (now - lw > WATER_COOLDOWN) thirsty++;
                        }
                    }
                });

                if (plantCount === 0) return "Hier ist es ja ganz leer! üèúÔ∏è Wir sollten dringend etwas pflanzen. Hast du genug M√ºnzen f√ºr Samen?";
                if (thirsty > 0) return "Oh nein! Alarm! üö® " + thirsty + " Pflanzen lassen die K√∂pfe h√§ngen. Sie brauchen dringend Wasser! üí¶";
                if (ready > 0) return "Juhuu! üåæ " + ready + " Pflanzen sind bereit f√ºr die Ernte. Hol dir die Edelsteine! üíé";
                if (coins < 20) return "Dein Sparschwein sieht mager aus (" + coins + " M√ºnzen). üí∏ Wie w√§re es mit einer kleinen Aufgabe?";
                
                return "Dein Garten sieht fantastisch aus! üåø Alles gr√ºnt und bl√ºht. Kann ich dir bei etwas anderem helfen?";
            },

            think: function(input, ctx) {
                const text = input.toLowerCase();
                const self = this; // Referenz f√ºr Closures

                // --- 1. SMALLTALK & PERS√ñNLICHKEIT ---
                if (text.match(/(hallo|hi|hey|moin|servus|gr√º√ü)/)) {
                    return this.getRandom(["Blub blub! üëã", "Hall√∂chen! üêô", "Ahoi! Bereit f√ºr Gartenarbeit?"]);
                }
                
                if (text.match(/(wie geht|alles klar|fit)/)) {
                    return this.getRandom([
                        "Mir geht's blendend! üåä Das Wasser ist herrlich heute.",
                        "Ein bisschen m√ºde vom vielen Schwimmen, aber f√ºr dich bin ich wach! üêô",
                        "Super! Ich habe gerade einen neuen Korallengarten entdeckt."
                    ]);
                }

                if (text.match(/(was machst du|wer bist du)/)) {
                    return "Ich bin Octo, dein pers√∂nlicher Garten-Assistent! üß† Ich habe 8 Arme, um dir bei allem gleichzeitig zu helfen. (Naja, fast allem).";
                }

                if (text.match(/(witz|lachen|spa√ü)/)) {
                    return this.getRandom([
                        "Was ist gr√ºn und klopft an die T√ºr? Ein Klopfsalat! ü•¨",
                        "Warum gie√üen G√§rtner so ungern? Weil sie Angst vor dem Wasserhahn haben! üö∞",
                        "Was sagt der gro√üe Stift zum kleinen Stift? Wachs mal! üå±"
                    ]);
                }

                if (text.match(/(danke|cool|super|top)/)) {
                    return this.getRandom(["Gerne doch! üêô", "Freut mich! üíô", "Jederzeit wieder! üåä"]);
                }

                if (text.match(/(blub|fisch|oktopus|tintenfisch)/)) {
                    return "Blub blub! ü´ß Wir Meeresbewohner m√ºssen zusammenhalten!";
                }

                // --- 2. KONTEXT & HILFE ---
                
                // Geld / Finanzen
                if (text.match(/(geld|m√ºnze|reich|arm|leisten|konto|finanz|kosten)/)) {
                    this.memory.lastTopic = "money";
                    const c = (ctx && ctx.roomData) ? (ctx.roomData.coins || 0) : 0;
                    if (c < 50) return "Du hast aktuell " + c + " M√ºnzen. ü™ô Das ist nicht viel. Soll ich dir sagen, wie du mehr bekommst?";
                    return "Du bist fl√ºssig! üí∞ " + c + " M√ºnzen auf dem Konto. G√∂nn dir doch was Sch√∂nes im Shop!";
                }

                // Follow-up: "Wie?" nach Geld
                if (this.memory.lastTopic === "money" && text.match(/(wie|mehr|woher|bekommen)/)) {
                    return "Ganz einfach: Erledige Aufgaben! üìã Schau unten in den Tab 'Aufgaben'. F√ºr jede erledigte Mission gibt es M√ºnzen.";
                }

                // Status Check
                if (text.match(/(status|garten|pflanze|wie geht|bericht|durst|wasser)/)) {
                    return this.analyzeState(ctx);
                }

                // Aufgaben
                if (text.match(/(tun|machen|aufgabe|quest|mission|langweil)/)) {
                    if(!ctx || !ctx.tasks) return "Keine Aufgaben da. Ruh dich aus!";
                    const openTasks = ctx.tasks.filter(function(t) { return !t.done; });
                    if(openTasks.length > 0) {
                        const t = openTasks[0];
                        return "Keine M√ºdigkeit vort√§uschen! üì¢ Mach die Aufgabe: '" + t.title + "'. Das bringt dir " + t.reward + " M√ºnzen!";
                    }
                    return "Wow, du hast alles erledigt! üåü Du bist der flei√üigste G√§rtner, den ich kenne.";
                }

                // --- 3. ANLEITUNGEN ---
                if (text.match(/(pflanz|s√§en|samen|anbau)/)) return "Pflanzen geht so: 1. Geh in den Shop (unten rechts). 2. Kauf Samen. 3. W√§hle sie im Garten-Tab unten aus. 4. Tippe auf ein freies Feld. üå±";
                if (text.match(/(ernt|sammel|fertig)/)) return "Siehst du den vollen blauen Balken √ºber einer Pflanze? üìè Das hei√üt, sie ist reif! Tippe sie an, um wertvolle Gems üíé zu ernten.";
                if (text.match(/(gem|edelstein|diamant)/)) return "Gems üíé sind die Premium-W√§hrung hier. Du findest sie nicht auf der Stra√üe, sondern musst sie ernten! Damit kannst du neue, gr√∂√üere G√§rten kaufen.";
                if (text.match(/(streak|flamme|feuer)/)) return "Der Streak üî• zeigt, wie viele Tage du in Folge aktiv warst. Wenn du mal einen Tag nichts machst... pffft... geht die Flamme aus! üïØÔ∏è";
                if (text.match(/(l√∂schen|weg|entfern|abbau)/)) return "Willst du umdekorieren? üé® Deko kannst du antippen, um sie einzupacken. Pflanzen sind hartn√§ckiger ‚Äì die musst du mit einem Bodenbelag '√ºberbauen', um sie loszuwerden.";
                if (text.match(/(code|freund|teilen)/)) return "Oben links steht dein Garten-Code. üé´ Gib ihn deinen Freunden, damit sie deinen Garten besuchen k√∂nnen!";

                // --- 4. FALLBACK ---
                return this.getRandom([
                    "Das habe ich akustisch nicht ganz verstanden. Hier unten im Wasser blubbert es so laut. üåä Frag mich nochmal nach Garten, Geld oder Pflanzen!",
                    "Hm, spannende Frage. Aber ich bin nur ein Experte f√ºr DuoBloom. üå∏ Frag mich lieber, wie man reich wird!",
                    "Meine 8 Arme kratzen sich am Kopf. üêô Was meinst du damit? Geht es um Pflanzen oder Aufgaben?"
                ]);
            }
        };

        const OctoChatInterface = ({ context }) => {
            const [messages, setMessages] = React.useState([
                { sender: 'octo', text: 'Lade Gehirn...' }
            ]);
            const [input, setInput] = React.useState("");
            const [isTyping, setIsTyping] = React.useState(false);
            const messagesEndRef = React.useRef(null);

            React.useEffect(() => {
                if(context && context.roomData) {
                    const initialMsg = OCTO_BRAIN.analyzeState(context);
                    setMessages([{ sender: 'octo', text: initialMsg }]);
                }
            }, []);

            React.useEffect(() => {
                if(messagesEndRef.current) messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
            }, [messages, isTyping]);

            const handleSend = () => {
                if(!input.trim()) return;
                const userMsg = { sender: 'user', text: input };
                setMessages(prev => [...prev, userMsg]);
                setInput("");
                setIsTyping(true);
                
                // Dynamische Antwortzeit f√ºr "menschliches" Gef√ºhl
                const thinkTime = 600 + Math.random() * 800;

                setTimeout(() => {
                    let reply = "Blub...";
                    try {
                        reply = OCTO_BRAIN.think(userMsg.text, context);
                    } catch(e) { console.error(e); }
                    
                    setIsTyping(false);
                    setMessages(prev => [...prev, { sender: 'octo', text: reply }]);
                }, thinkTime);
            };

            return (
                <div className="chat-container">
                    <div className="bg-white p-4 shadow-sm border-b flex items-center gap-3 sticky top-0 z-10">
                        <div className="relative group cursor-pointer">
                            <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Octopus.png" className="w-12 h-12 drop-shadow-md group-hover:scale-110 transition-transform" />
                            <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white animate-pulse"></div>
                        </div>
                        <div>
                            <h2 className="font-bold text-gray-800 text-lg">Octo-Bot</h2>
                            <p className="text-xs text-blue-500 font-bold uppercase tracking-wider">Dein Assistent</p>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 flex flex-col gap-3 pb-24">
                        {messages.map((msg, i) => (
                            <div key={i} className={`flex items-end gap-2 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                {msg.sender === 'octo' && (
                                    <img 
                                        src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Octopus.png" 
                                        className="w-8 h-8 mb-1 drop-shadow-sm animate-pop" 
                                    />
                                )}
                                <div className={`chat-bubble ${msg.sender === 'user' ? 'chat-user' : 'chat-octo'}`}>
                                    {msg.text}
                                </div>
                            </div>
                        ))}
                        
                        {isTyping && (
                            <div className="flex items-end gap-2 justify-start">
                                <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Octopus.png" className="w-8 h-8 mb-1 drop-shadow-sm" />
                                <div className="chat-bubble chat-octo typing-indicator">
                                    <span></span><span></span><span></span>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    <div className="p-4 bg-white border-t flex gap-2 items-center absolute bottom-0 w-full shadow-lg">
                        <input 
                            value={input}
                            onChange={e => setInput(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && handleSend()}
                            placeholder="Schreib mit Octo..."
                            className="flex-1 bg-gray-100 border-0 rounded-full px-5 py-3 text-sm focus:ring-2 focus:ring-blue-400 outline-none"
                        />
                        <button onClick={handleSend} className="bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600 transition-transform active:scale-95 shadow-md">
                            <Icon name="send" size={20} />
                        </button>
                    </div>
                </div>
            );
        };

        // --- 3. GRID CELL ---

        const GridCell = ({ x, y, cell, handleGridClick, now }) => {
            const floorItem = cell.floor ? ITEMS[cell.floor] : null;
            const objectItem = cell.item ? ITEMS[cell.item] : null;
            let showTimer = false, timeLeftStr = "";

            if (objectItem && objectItem.type === 'seed' && !cell.grown) {
                const lastWatered = cell.lastWatered ? new Date(cell.lastWatered).getTime() : 0;
                const diff = now - lastWatered;
                if (diff < WATER_COOLDOWN) {
                    showTimer = true;
                    const ms = WATER_COOLDOWN - diff;
                    const h = Math.floor(ms / 3600000);
                    const m = Math.floor((ms % 3600000) / 60000);
                    timeLeftStr = h + "h " + m + "m";
                }
            }

            return (
                <div onClick={() => handleGridClick(x, y)} className={`w-14 h-14 md:w-20 md:h-20 relative cursor-pointer ${floorItem ? floorItem.css : 'bg-white/10 border border-white/20'}`}>
                    {objectItem && (
                        <div className="absolute inset-0 flex items-center justify-center z-10 hover:scale-110 transition-transform">
                            {cell.grown || objectItem.type === 'deco' ? (
                                <ItemDisplay item={objectItem} className="w-10 h-10 md:w-16 md:h-16" />
                            ) : (
                                <div className="flex flex-col items-center relative">
                                    <ItemDisplay item={objectItem} className="w-8 h-8 md:w-12 md:h-12" />
                                    {showTimer ? (
                                        <div className="absolute -top-4 bg-black/70 text-white text-[8px] md:text-[10px] px-1.5 rounded-full backdrop-blur-sm pointer-events-none whitespace-nowrap">{timeLeftStr}</div>
                                    ) : (
                                        <div className="absolute -top-4 bg-blue-500 text-white text-[8px] px-1 rounded-full animate-bounce">Gie√üen!</div>
                                    )}
                                    <div className="w-8 h-1 bg-black/20 rounded-full mt-1 overflow-hidden">
                                        <div className="h-full bg-blue-500 transition-all" style={{width: `${(cell.stage/objectItem.stages)*100}%`}} />
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {!objectItem && floorItem && <div className="absolute inset-0 hover:bg-white/20"></div>}
                </div>
            );
        };

        // --- 4. ERROR BOUNDARY & MODALS ---

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            async handleReset() {
                if(confirm("Daten reparieren?")) {
                    const roomRef = doc(db, 'rooms', this.props.roomCode);
                    await setDoc(roomRef, { tasks: [], inventory: {}, gardens: {0:{}} }, { merge: true });
                    window.location.reload();
                }
            }
            render() {
                if (this.state.hasError) { return <div className="p-4 text-red-500">Fehler! <button onClick={()=>window.location.reload()} className="underline">Neustart</button></div>; }
                return this.props.children; 
            }
        }

        const Modal = ({ children, onClose, title }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-pop">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]">
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                        <button onClick={onClose}><Icon name="x" className="text-gray-500 hover:text-red-500" /></button>
                    </div>
                    <div className="p-4 overflow-y-auto">{children}</div>
                </div>
            </div>
        );

        const InstallHelpModal = ({ onClose }) => {
            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
            return (
                <Modal title="App installieren" onClose={onClose}>
                    <div className="space-y-4 text-center">
                        <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto text-green-600 mb-2"><Icon name="download" size={32} /></div>
                        {isIOS ? (
                            <ol className="text-left bg-gray-50 p-4 rounded-xl space-y-2 text-sm text-gray-700 border border-gray-200">
                                <li className="flex items-center gap-2">1. Tippe auf <strong className="text-blue-500 flex items-center gap-1">Teilen <Icon name="share" size={14}/></strong></li>
                                <li className="flex items-center gap-2">2. W√§hle <strong>"Zum Home-Bildschirm"</strong></li>
                            </ol>
                        ) : (
                            <ol className="text-left bg-gray-50 p-4 rounded-xl space-y-2 text-sm text-gray-700 border border-gray-200">
                                <li className="flex items-center gap-2">1. Tippe auf das <strong>Browser-Men√º</strong></li>
                                <li className="flex items-center gap-2">2. W√§hle <strong>"App installieren"</strong></li>
                            </ol>
                        )}
                        <button onClick={onClose} className="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-xl mt-4">Verstanden</button>
                    </div>
                </Modal>
            );
        };
        // --- 4.1 OCTO AI (OFFLINE VERSION) ---

        const OctoChat = ({ user }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const [messages, setMessages] = React.useState([
                { role: 'assistant', content: 'Blub Blub! üêô Ich bin Octo. Ich kenne jeden Grashalm hier. Frag mich was zum Spiel!' }
            ]);
            const [input, setInput] = React.useState("");
            const [isTyping, setIsTyping] = React.useState(false);
            const messagesEndRef = React.useRef(null);

            const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); };
            React.useEffect(() => { scrollToBottom(); }, [messages, isOpen, isTyping]);

            // --- DAS GEHIRN VON OCTO ---
            const getOctoResponse = (text) => {
                const t = text.toLowerCase();
                
                // 1. BEGR√úSSUNG & SMALLTALK
                if (t.match(/(hallo|hi|hey|moin|guten tag)/)) return "Halli Hallo! Bereit zum G√§rtnern? üåø";
                if (t.match(/(wie geht|alles klar|was machst du)/)) return "Mir geht's blendend! Ich genie√üe die Feuchtigkeit hier im Garten. Und dir? üíß";
                if (t.match(/(wer bist du|dein name)/)) return "Ich bin Octo! Der schlaue Garten-Oktopus. Ich passe auf, dass hier alles w√§chst. üêô";
                if (t.match(/(danke|cool|super)/)) return "Gerne doch! Immer flei√üig bleiben! ‚ú®";
                if (t.match(/(witz|lachen)/)) {
                    const jokes = [
                        "Was ist gr√ºn und klopft an die T√ºr? Ein Klopfsalat!",
                        "Warum k√∂nnen G√§rtner nicht reich werden? Weil sie immer alles vergraben.",
                        "Was macht eine Pflanze im Matheunterricht? Wurzeln ziehen!"
                    ];
                    return jokes[Math.floor(Math.random() * jokes.length)];
                }

                // 2. PFLANZEN WISSEN
                if (t.includes("karotte")) return "Karotten ü•ï kosten 20 M√ºnzen. Sie brauchen 3 Stufen zum Wachsen. Perfekt f√ºr Anf√§nger!";
                if (t.includes("sonnenblume")) return "Sonnenblumen üåª bringen 20 Gems Belohnung! Aber sie brauchen etwas l√§nger (4 Stufen).";
                if (t.includes("vergiss")) return "Das Vergissmeinnicht ü™ª ist unsere Premium-Blume. Teuer im Einkauf, aber es lohnt sich!";
                
                // 3. GAMEPLAY MECHANIKEN
                if (t.match(/(wasser|gie√üen|gie√üt|trocken)/)) return "Pflanzen muss man alle 6 Stunden gie√üen! üíß Wenn sie blau leuchten oder h√ºpfen, haben sie Durst.";
                if (t.match(/(m√ºnzen|geld|verdienen|coin)/)) return "M√ºnzen bekommst du durch Aufgaben! Schau mal im Tab 'Aufgaben' vorbei. üí∞";
                if (t.match(/(gem|diamant|kristall)/)) return "Gems üíé bekommst du, wenn du fertige Pflanzen erntest. Damit kannst du neue Gartenbereiche kaufen!";
                if (t.match(/(ernten|pfl√ºcken)/)) return "Klicke auf eine fertig gewachsene Pflanze, um sie zu ernten und Gems zu kassieren! üß∫";
                if (t.match(/(weg|l√∂schen|entfernen)/)) return "Willst du was l√∂schen? Klicke auf ein leeres Feld oder eine Pflanze. Octo fragt dich dann zur Sicherheit nochmal.";
                if (t.match(/(speichern|save)/)) return "Keine Sorge, DuoBloom speichert alles automatisch in der Cloud! ‚òÅÔ∏è";
                if (t.match(/(freunde|besuchen|code)/)) return "Du kannst Freunde besuchen! Gib ihren Code im Hauptmen√º ein. Deinen Code siehst du oben rechts.";
                if (t.match(/(level|aufsteigen)/)) return "Dein Level h√§ngt davon ab, wie viele G√§rten du freigeschaltet hast. Kauf mehr Land im Shop!";

                // 4. SONSTIGES
                if (t.includes("liebe")) return "Ich liebe diesen Garten auch! ‚ù§Ô∏è";
                if (t.includes("octo")) return "Jaaa? Das bin ich! üêô";

                // 5. FALLBACK (Wenn er nichts versteht)
                const fallbacks = [
                    "Das ist eine tiefe Frage... f√ºr einen Oktopus zu tief. Frag mich lieber was zu Pflanzen! üåø",
                    "Blub? Das habe ich nicht verstanden. Geht es um Karotten? ü•ï",
                    "Interessant! Aber hast du schon deine Blumen gegossen? üíß",
                    "Dazu steht nichts in meinem Gartenbuch. ü§î"
                ];
                return fallbacks[Math.floor(Math.random() * fallbacks.length)];
            };

            const handleSend = () => {
                if (!input.trim()) return;
                const userText = input;
                setMessages(prev => [...prev, { role: 'user', content: userText }]);
                setInput("");
                setIsTyping(true);

                // Simuliere Denkzeit (zuf√§llig zwischen 500ms und 1500ms)
                setTimeout(() => {
                    const answer = getOctoResponse(userText);
                    setMessages(prev => [...prev, { role: 'assistant', content: answer }]);
                    setIsTyping(false);
                }, 800);
            };

            return (
                <>
                    <button 
                        onClick={() => setIsOpen(true)} 
                        className="fixed bottom-20 right-4 md:bottom-8 md:right-8 z-40 bg-purple-600 hover:bg-purple-700 text-white p-3 md:p-4 rounded-full shadow-xl border-4 border-white transition-transform hover:scale-110 flex items-center justify-center animate-bounce"
                    >
                        <span className="text-2xl md:text-3xl">üêô</span>
                    </button>

                    {isOpen && (
                        <div className="fixed inset-0 z-[60] flex items-end md:items-center justify-center pointer-events-none">
                            <div className="bg-white w-full md:w-[380px] h-[70vh] md:h-[550px] md:rounded-3xl shadow-2xl flex flex-col pointer-events-auto overflow-hidden animate-pop border border-gray-200 m-0 md:m-4">
                                <div className="bg-purple-600 p-4 text-white flex justify-between items-center shadow-md">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-white/20 p-2 rounded-full"><span className="text-2xl">üêô</span></div>
                                        <div>
                                            <h3 className="font-bold text-lg">Octo</h3>
                                            <p className="text-[10px] text-purple-200 font-mono uppercase">Garten-Guide v1.0</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setIsOpen(false)}><Icon name="x" className="text-white/80 hover:text-white" /></button>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 bg-[#f8fafc] space-y-4">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] p-3 px-4 rounded-2xl text-sm leading-relaxed shadow-sm ${
                                                m.role === 'user' 
                                                ? 'bg-purple-600 text-white rounded-br-none' 
                                                : 'bg-white border border-gray-100 text-gray-700 rounded-bl-none'
                                            }`}>
                                                {m.content}
                                            </div>
                                        </div>
                                    ))}
                                    {isTyping && (
                                        <div className="flex justify-start">
                                            <div className="bg-white border border-gray-100 p-3 rounded-2xl rounded-bl-none shadow-sm flex gap-1">
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'0s'}}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'0.1s'}}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'0.2s'}}></div>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                <div className="p-3 bg-white border-t border-gray-100 flex gap-2">
                                    <input 
                                        value={input}
                                        onChange={e => setInput(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && handleSend()}
                                        placeholder="Frage stellen..."
                                        className="flex-1 bg-gray-100 rounded-xl px-4 py-3 outline-none focus:bg-white focus:ring-2 ring-purple-500 transition-all text-sm font-medium"
                                        autoFocus
                                    />
                                    <button onClick={handleSend} disabled={!input.trim() || isTyping} className="bg-purple-600 text-white p-3 rounded-xl hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg shadow-purple-200">
                                        <Icon name="send" size={20} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        // --- 5. SCREENS ---

        const CommunityList = ({ onVisit, onBack }) => {
            const [list, setList] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            React.useEffect(() => {
                const timer = setTimeout(() => { try { lucide.createIcons(); } catch(e) {} }, 100);
                const fetchG = async () => { try { const q = query(collection(db, 'rooms'), limit(50)); const snap = await getDocs(q); const sorted = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.likes||0) - (a.likes||0)); setList(sorted); } catch(e) { console.error(e); } setLoading(false); }; fetchG();
                return () => clearTimeout(timer);
            }, []);
            React.useEffect(() => { const t = setTimeout(() => { try { lucide.createIcons(); } catch(e) {} }, 100); return () => clearTimeout(t); }, [list]);
            return (
                <div className="h-full bg-slate-50 flex flex-col md:max-w-4xl md:mx-auto md:my-8 md:rounded-3xl shadow-xl overflow-hidden">
                    <div className="p-6 bg-white shadow-sm flex items-center gap-4"><button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-full"><Icon name="home" className="text-gray-600"/></button><h2 className="text-2xl font-bold text-gray-800">Community G√§rten</h2></div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-3">
                        {loading && <div>Lade Liste...</div>}
                        {list.map(g => (<div key={g.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition-shadow"><div><div className="font-bold text-lg text-gray-800">{g.roomName || "Unbenannter Garten"}</div><div className="text-sm text-gray-500 flex gap-3"><span className="text-red-500 flex items-center gap-1"><Icon name="heart" size={12}/> {g.likes||0}</span><span>Level {g.unlockedGardens?.length || 1}</span></div></div><button onClick={() => onVisit(g.id)} className="bg-purple-100 text-purple-700 px-4 py-2 rounded-xl font-bold hover:bg-purple-200">Besuchen</button></div>))}
                    </div>
                </div>
            );
        };

        const MainMenu = ({ user, onAction, currentRoom }) => {
            const [joinCode, setJoinCode] = React.useState("");
            const [isCreating, setIsCreating] = React.useState(false);
            const [newGardenName, setNewGardenName] = React.useState("");
            const [isBusy, setIsBusy] = React.useState(false);
            const [installPrompt, setInstallPrompt] = React.useState(null);
            const [showInstallHelp, setShowInstallHelp] = React.useState(false);
            const [streak, setStreak] = React.useState(0);

            React.useEffect(() => { 
                if(window.lucide) try{window.lucide.createIcons();}catch(e){}
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setInstallPrompt(e); });
                
                if(currentRoom && db) {
                    const unsub = onSnapshot(doc(db, 'rooms', currentRoom), (snap) => {
                        if(snap.exists()) {
                            const data = snap.data();
                            const d = new Date();
                            const year = d.getFullYear();
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const day = String(d.getDate()).padStart(2, '0');
                            const today = `${year}-${month}-${day}`;
                            
                            d.setDate(d.getDate() - 1);
                            const yesterdayYear = d.getFullYear();
                            const yesterdayMonth = String(d.getMonth() + 1).padStart(2, '0');
                            const yesterdayDay = String(d.getDate()).padStart(2, '0');
                            const yesterday = `${yesterdayYear}-${yesterdayMonth}-${yesterdayDay}`;
                            
                            let s = data.currentStreak || 0;
                            const last = data.lastStreakDate;
                            if (last !== today && last !== yesterday) s = 0; 
                            setStreak(s);
                        }
                    }, (err) => console.log("Streak error", err));
                    return () => unsub();
                }
            }, [currentRoom]);

            const handleCreate = async () => {
                if(!newGardenName.trim()) return alert("Bitte Namen eingeben");
                setIsBusy(true);
                await onAction('create', null, newGardenName);
                setIsBusy(false);
                setIsCreating(false);
            };

            const handleInstallClick = () => {
                if (installPrompt) {
                    installPrompt.prompt();
                    installPrompt.userChoice.then((res) => { if (res.outcome === 'accepted') setInstallPrompt(null); });
                } else { setShowInstallHelp(true); }
            };

            const streakBg = getStreakStyle(streak);

            return (
                <div className="h-full bg-slate-100 flex flex-col md:flex-row max-w-5xl mx-auto shadow-xl md:rounded-3xl md:my-8 overflow-hidden">
                    <div className="bg-white p-6 flex flex-col items-center border-b md:border-b-0 md:border-r border-gray-100 shadow-sm z-10 md:w-1/3 flex-shrink-0">
                        <div className="flex items-center gap-4 w-full md:flex-col">
                            <img src={user.photoURL} className="w-16 h-16 md:w-24 md:h-24 rounded-full border-4 border-green-500 shadow-lg" />
                            <div className="text-left md:text-center"><h1 className="text-xl md:text-2xl font-bold text-gray-800">{user.displayName}</h1><p className="text-xs text-gray-400">ID: {user.uid.slice(0,5)}</p></div>
                            <button onClick={() => auth.signOut()} className="ml-auto md:ml-0 md:mt-auto text-red-500 font-bold bg-red-50 p-2 rounded-lg"><Icon name="log-out" /></button>
                        </div>
                        <div className="hidden md:flex flex-col w-full space-y-2 mt-8">
                            <button onClick={() => onAction('community')} className="w-full bg-purple-50 border border-purple-200 p-3 rounded-xl text-purple-700 font-bold flex items-center justify-center gap-2 hover:bg-purple-100 transition-colors"><Icon name="globe" /> Community</button>
                            <button onClick={handleInstallClick} className="w-full bg-green-50 border border-green-200 p-3 rounded-xl text-green-700 font-bold flex items-center justify-center gap-2 hover:bg-green-100 transition-colors"><Icon name="plus-square" /> App installieren</button>
                        </div>
                    </div>
                    <div className="flex-1 bg-[#f8fafc] p-6 flex flex-col gap-6 overflow-y-auto">
                        <h2 className="text-2xl font-bold text-gray-700">Dashboard</h2>
                        {currentRoom && (
                            <div className={`bg-gradient-to-r ${streakBg} w-full flex-shrink-0 p-6 rounded-3xl shadow-lg flex items-center justify-between text-white relative overflow-hidden mb-4 min-h-[120px] transition-all duration-500`}>
                                <div className="z-10 relative">
                                    <div className="text-xs font-bold uppercase tracking-wider opacity-90 mb-1">Dein Streak</div>
                                    <div className="text-4xl font-black flex items-baseline gap-2">{streak} <span className="text-base font-medium opacity-90">Tage</span></div>
                                    <div className="text-xs font-medium opacity-80 mt-1">{streak === 0 ? "Fang heute an!" : "Bleib dran! üî•"}</div>
                                </div>
                                <div className="text-6xl animate-pulse z-10 drop-shadow-md transform translate-x-2">üî•</div>
                                <div className="absolute -right-4 -bottom-8 bg-white opacity-10 w-32 h-32 rounded-full blur-2xl pointer-events-none"></div>
                            </div>
                        )}
                        {currentRoom ? (
                            <button onClick={() => onAction('resume', currentRoom)} className="bg-white border-2 border-green-500 text-green-600 p-6 rounded-2xl shadow-sm hover:bg-green-50 transition-all text-left flex items-center justify-between group flex-shrink-0">
                                <div><div className="text-green-800 text-sm font-bold uppercase mb-1">Letzte Sitzung</div><div className="text-2xl font-bold">Weiterg√§rtnern</div><div className="text-sm opacity-80 font-mono mt-1">Code: {currentRoom}</div></div>
                                <div className="bg-green-100 p-3 rounded-full"><Icon name="play" className="text-green-600" /></div>
                            </button>
                        ) : <div className="bg-gray-100 p-4 rounded-xl text-center text-gray-500 italic flex-shrink-0">Kein Garten besucht.</div>}
                        <hr className="border-gray-200" />
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20">
                            <button onClick={() => setIsCreating(true)} className="bg-white border-2 border-dashed border-gray-300 p-6 rounded-2xl text-gray-500 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center justify-center gap-2 h-32 flex-shrink-0"><div className="bg-blue-100 p-3 rounded-full text-blue-500"><Icon name="plus" /></div><span className="font-bold">Neuer Garten</span></button>
                            <div className="bg-white border border-gray-200 p-6 rounded-2xl flex flex-col justify-center h-32 flex-shrink-0"><label className="text-xs font-bold text-gray-400 uppercase mb-2">Code eingeben</label><div className="flex gap-2"><input value={joinCode} onChange={e => setJoinCode(e.target.value.toUpperCase())} placeholder="CODE" className="w-full bg-gray-100 rounded-lg px-3 py-2 font-bold uppercase focus:ring-2 ring-blue-500 outline-none" /><button onClick={() => joinCode && onAction('join', joinCode)} className="bg-blue-500 text-white px-3 rounded-lg font-bold hover:bg-blue-600 transition-colors"><Icon name="arrow-right" /></button></div></div>
                            <button onClick={() => onAction('community')} className="md:hidden bg-purple-50 border border-purple-200 p-4 rounded-2xl text-purple-700 font-bold flex items-center justify-center gap-2 hover:bg-purple-100 flex-shrink-0"><Icon name="globe" /> Community</button>
                            <button onClick={handleInstallClick} className="md:hidden bg-green-50 border border-green-200 p-4 rounded-2xl text-green-700 font-bold flex items-center justify-center gap-2 hover:bg-green-100 flex-shrink-0"><Icon name="plus-square" /> App installieren</button>
                        </div>
                    </div>
                    {isCreating && (
                        <Modal title="Garten benennen" onClose={() => !isBusy && setIsCreating(false)}><div className="space-y-4"><input autoFocus value={newGardenName} onChange={e => setNewGardenName(e.target.value)} placeholder="Name..." className="w-full border rounded-xl p-3 outline-none" disabled={isBusy} /><button onClick={handleCreate} disabled={isBusy} className={`w-full text-white font-bold py-3 rounded-xl ${isBusy ? 'bg-gray-400' : 'bg-green-500'}`}>{isBusy ? '...' : 'Erstellen'}</button></div></Modal>
                    )}
                    {showInstallHelp && <InstallHelpModal onClose={() => setShowInstallHelp(false)} />}
                </div>
            );
        };

        const GameApp = ({ user, roomCode, isSpectator, onBackToMenu }) => {
            const [roomData, setRoomData] = React.useState(null);
            const [tab, setTab] = React.useState('garden');
            const [activeGardenIdx, setActiveGardenIdx] = React.useState(0);
            const [selectedItem, setSelectedItem] = React.useState(null);
            const [isTaskModalOpen, setTaskModalOpen] = React.useState(false);
            const [taskFilter, setTaskFilter] = React.useState('active'); 
            const [newTaskTitle, setNewTaskTitle] = React.useState("");
            const [newTaskReward, setNewTaskReward] = React.useState(15);
            const [newTaskType, setNewTaskType] = React.useState("once");
            const [newTaskDeadline, setNewTaskDeadline] = React.useState("");
            const [now, setNow] = React.useState(Date.now());
            const [hasLiked, setHasLiked] = React.useState(false);

            React.useEffect(() => {
                if(!roomCode || !db) return;
                const unsub = onSnapshot(doc(db, 'rooms', roomCode), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        if(!data.tasks) data.tasks = [];
                        if(!data.inventory) data.inventory = {};
                        if(!data.gardens) data.gardens = { 0: {} };
                        if(!data.unlockedGardens) data.unlockedGardens = [0];
                        
                        const d = new Date();
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const today = `${year}-${month}-${day}`;
                        
                        if (!isSpectator) {
                            const thirtyDaysAgo = new Date(); 
                            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                            
                            const currentTasks = Array.isArray(data.tasks) ? data.tasks : [];
                            const validTasks = currentTasks.filter(t => {
                                if (t.type === 'once' && t.deadline && !t.done && t.deadline < today) return false;
                                return true;
                            });
                            
                            if (validTasks.length !== currentTasks.length) updateDoc(doc(db, 'rooms', roomCode), { tasks: validTasks });
                            if (data.lastDailyReset !== today) updateDoc(doc(db, 'rooms', roomCode), { lastDailyReset: today });
                        }
                        setRoomData(data);
                    } else if (isSpectator) { alert("Raum nicht gefunden."); onBackToMenu(); }
                }, err => console.log("DB Error", err));
                if (localStorage.getItem(`liked_${roomCode}`)) setHasLiked(true);
                return () => unsub();
            }, [roomCode, isSpectator]);

            React.useEffect(() => { const t = setInterval(() => setNow(Date.now()), 1000); return () => clearInterval(t); }, []);
            
            React.useEffect(() => { 
                const t = setTimeout(() => { 
                    if(window.lucide) try{window.lucide.createIcons();}catch(e){} 
                }, 100); 
                return () => clearTimeout(t); 
            }, [roomData, tab, taskFilter]);

            const getGardens = () => roomData?.gardens || { 0: {} };
            const getCurrentGrid = () => (getGardens()[activeGardenIdx] || {});
            const getInventory = () => roomData?.inventory || {};
            const getTasks = () => Array.isArray(roomData?.tasks) ? roomData.tasks : [];

            const handleLike = async () => { if(hasLiked || !isSpectator) return; await updateDoc(doc(db, 'rooms', roomCode), { likes: increment(1) }); localStorage.setItem(`liked_${roomCode}`, 'true'); setHasLiked(true); };
            
            const handleGridClick = async (x, y) => {
                if (isSpectator || !roomData) return;
                const key = `${x},${y}`;
                const cell = getCurrentGrid()[key] || {};
                const roomRef = doc(db, 'rooms', roomCode);
                const path = `gardens.${activeGardenIdx}.${key}`;

                if (selectedItem) {
                    const itemDef = ITEMS[selectedItem];
                    const invCount = getInventory()[selectedItem] || 0;
                    if (invCount > 0) {
                        if (itemDef.type === 'floor') { if (cell.item) return alert("Erst Pflanze entfernen!"); await updateDoc(roomRef, { [`${path}.floor`]: selectedItem, [`inventory.${selectedItem}`]: increment(-1) }); }
                        else if (itemDef.type === 'seed' && !cell.floor && !cell.item) await updateDoc(roomRef, { [`${path}.item`]: selectedItem, [`${path}.stage`]: 0, [`${path}.plantedAt`]: new Date().toISOString(), [`inventory.${selectedItem}`]: increment(-1) });
                        else if (itemDef.type === 'deco' && !cell.item) await updateDoc(roomRef, { [`${path}.item`]: selectedItem, [`inventory.${selectedItem}`]: increment(-1) });
                        if (invCount - 1 <= 0) setSelectedItem(null);
                    }
                    return;
                }
                
                if (cell.item) {
                    const itemDef = ITEMS[cell.item];
                    if(!itemDef) return; 
                    
                    if (cell.grown && itemDef.type === 'seed') { 
                        await updateDoc(roomRef, { [`${path}.item`]: deleteField(), [`${path}.stage`]: deleteField(), [`${path}.grown`]: deleteField(), gems: increment(itemDef.reward || 0) }); 
                    } else if (itemDef.type === 'seed') {
                        const lastWatered = cell.lastWatered ? new Date(cell.lastWatered).getTime() : 0;
                        if (now - lastWatered > WATER_COOLDOWN) { const newStage = (cell.stage || 0) + 1; await updateDoc(roomRef, { [`${path}.stage`]: newStage, [`${path}.grown`]: newStage >= itemDef.stages, [`${path}.lastWatered`]: new Date().toISOString() }); }
                    } else if (itemDef.type === 'deco') {
                        if(confirm(`${itemDef.name} ins Inventar zur√ºck?`)) {
                            await updateDoc(roomRef, { [`${path}.item`]: deleteField(), [`inventory.${cell.item}`]: increment(1) });
                        }
                    }
                    return;
                }
                
                if (cell.floor) {
                    const floorDef = ITEMS[cell.floor];
                    if(confirm(`${floorDef.name} aufheben?`)) {
                        await updateDoc(roomRef, { [`${path}.floor`]: deleteField(), [`inventory.${cell.floor}`]: increment(1) });
                    }
                }
            };

            const createTask = async () => { if (!newTaskTitle.trim()) return; const task = { id: Date.now().toString(), title: newTaskTitle, reward: parseInt(newTaskReward), type: newTaskType, deadline: newTaskDeadline || null, done: false, lastDone: null, completedBy: null, completedAt: null, completedAtISO: null }; await updateDoc(doc(db, 'rooms', roomCode), { tasks: arrayUnion(task) }); setTaskModalOpen(false); setNewTaskTitle(""); };
            
            const toggleTask = async (task) => {
                if (isSpectator) return;
                
                const d = new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const today = `${year}-${month}-${day}`;

                const yesterdayDate = new Date();
                yesterdayDate.setDate(yesterdayDate.getDate() - 1);
                const yYear = yesterdayDate.getFullYear();
                const yMonth = String(yesterdayDate.getMonth() + 1).padStart(2, '0');
                const yDay = String(yesterdayDate.getDate()).padStart(2, '0');
                const yesterday = `${yYear}-${yMonth}-${yDay}`;

                const nowStr = new Date().toLocaleString('de-DE');
                const nowISO = new Date().toISOString();

                const updatedTasks = getTasks().map(t => { if (t.id === task.id) { return t.type === 'daily' ? { ...t, done: true, lastDone: today, completedBy: user.displayName, completedAt: nowStr, completedAtISO: nowISO } : { ...t, done: true, completedBy: user.displayName, completedAt: nowStr, completedAtISO: nowISO }; } return t; });
                const updates = { tasks: updatedTasks, coins: increment(task.reward) };
                
                const lastStreakDate = roomData.lastStreakDate;
                if (lastStreakDate !== today) {
                    let newStreak = Number(roomData.currentStreak || 0);
                    if (lastStreakDate === yesterday) newStreak += 1;
                    else newStreak = 1;
                    updates.currentStreak = newStreak;
                    updates.lastStreakDate = today;
                    alert(`Streak erh√∂ht! üî• Neuer Streak: ${newStreak} Tage`);
                }
                
                await updateDoc(doc(db, 'rooms', roomCode), updates);
            };

            const deleteTask = async (task) => {
                if(!confirm("Wirklich l√∂schen?")) return;
                const newTasks = getTasks().filter(t => t.id !== task.id);
                await updateDoc(doc(db, 'rooms', roomCode), { tasks: newTasks });
            };

            const buy = async (id, isGarden) => {
                if (isSpectator) return;
                if(isGarden) { const g = GARDEN_UPGRADES.find(x => x.id === id); if(roomData.gems >= g.price) await updateDoc(doc(db, 'rooms', roomCode), { gems: increment(-g.price), unlockedGardens: arrayUnion(id), [`gardens.${id}`]: {} }); }
                else { const item = ITEMS[id]; if (roomData.coins >= item.price) await updateDoc(doc(db, 'rooms', roomCode), { coins: increment(-item.price), [`inventory.${id}`]: increment(1) }); }
            };

            if (!roomData) return <div className="h-full flex items-center justify-center animate-pulse">Lade Garten...</div>;

            // OCTOBOT CONTEXT INJECTION (HIER IST DIE L√ñSUNG)
            const octoContext = {
                roomData: roomData,
                user: user,
                tasks: getTasks(),
                activeGardenIdx: activeGardenIdx
            };

            return (
                <div className={`flex h-full bg-slate-100 overflow-hidden md:max-w-7xl md:mx-auto md:my-8 md:rounded-3xl md:shadow-2xl md:border ${isSpectator ? 'border-purple-300 ring-4 ring-purple-100' : 'border-slate-200'}`}>
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t z-40 flex justify-around p-2 pb-safe md:relative md:w-64 md:flex-col md:justify-start md:border-t-0 md:border-r md:p-6 md:gap-4">
                        <div className="hidden md:block mb-8"><h1 className="text-2xl font-bold text-green-600 flex items-center gap-2"><Icon name="sprout"/> DuoBloom</h1>{isSpectator && <div className="bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded mt-2 font-bold uppercase text-center">Zuschauer</div>}</div>
                        <button onClick={() => setTab('garden')} className={`p-3 rounded-xl flex md:flex-row flex-col items-center gap-3 transition-all ${tab === 'garden' ? 'bg-green-50 text-green-600 font-bold' : 'text-gray-400 hover:bg-gray-50'}`}><Icon name="flower-2"/> <span className="text-[10px] md:text-sm">Garten</span></button>
                        {!isSpectator && <><button onClick={() => setTab('tasks')} className={`p-3 rounded-xl flex md:flex-row flex-col items-center gap-3 transition-all ${tab === 'tasks' ? 'bg-blue-50 text-blue-600 font-bold' : 'text-gray-400 hover:bg-gray-50'}`}><Icon name="check-square"/> <span className="text-[10px] md:text-sm">Aufgaben</span></button><button onClick={() => setTab('shop')} className={`p-3 rounded-xl flex md:flex-row flex-col items-center gap-3 transition-all ${tab === 'shop' ? 'bg-orange-50 text-orange-600 font-bold' : 'text-gray-400 hover:bg-gray-50'}`}><Icon name="shopping-cart"/> <span className="text-[10px] md:text-sm">Shop</span></button><button onClick={() => setTab('octo')} className={`p-3 rounded-xl flex md:flex-row flex-col items-center gap-3 transition-all ${tab === 'octo' ? 'bg-indigo-50 text-indigo-600 font-bold' : 'text-gray-400 hover:bg-gray-50'}`}><Icon name="message-circle"/> <span className="text-[10px] md:text-sm">Hilfe</span></button></>}
                    </nav>
                    <main className="flex-1 overflow-y-auto bg-[#eefcf3] relative pb-28 md:pb-0">
                        <header className={`sticky top-0 backdrop-blur-md p-4 shadow-sm z-30 flex justify-between items-center px-6 ${isSpectator ? 'bg-purple-50/90' : 'bg-white/90'}`}>
                            <div className="flex items-center gap-4"><button onClick={onBackToMenu} className="bg-white border p-2 rounded-xl hover:bg-gray-100 shadow-sm" title="Zur√ºck"><Icon name="home" className="text-gray-600"/></button><div className="flex flex-col"><span className="font-bold text-gray-700 truncate max-w-[150px] md:max-w-none text-lg">{roomData.roomName}</span><span className="text-[10px] text-gray-400 font-mono">{isSpectator ? `Besuche: ${roomCode}` : `Code: ${roomCode}`}</span></div></div>
                            <div className="flex gap-4 ml-auto items-center">{isSpectator ? <button onClick={handleLike} className={`flex items-center gap-2 px-3 py-1 rounded-full text-sm font-bold transition-all ${hasLiked ? 'bg-red-100 text-red-500' : 'bg-white border hover:bg-red-50 text-gray-500'}`}><Icon name="heart" className={hasLiked ? "fill-red-500" : ""}/> {roomData.likes || 0}</button> : <div className="flex flex-col items-end"><span className="font-bold text-yellow-600 text-lg flex items-center gap-1">üí∞ {roomData.coins}</span><span className="font-bold text-purple-600 text-lg flex items-center gap-1">üíé {roomData.gems}</span></div>}</div>
                        </header>
                        
                        {tab === 'garden' && (
                            <div className="p-4 md:p-8 flex flex-col items-center">
                                <div className="flex gap-2 mb-4 overflow-x-auto w-full justify-center">{GARDEN_UPGRADES.map(g => { const owned = (roomData.unlockedGardens || []).includes(g.id); if(!owned) return null; return <button key={g.id} onClick={() => setActiveGardenIdx(g.id)} className={`px-4 py-1 rounded-full text-sm font-bold border ${activeGardenIdx === g.id ? 'bg-green-500 text-white border-green-500' : 'bg-white text-green-700 border-green-200'}`}>{g.name}</button> })}</div>
                                
                                <div className="p-4 rounded-xl shadow-2xl relative inline-block bg-cover bg-center" style={{ backgroundImage: `url(${GARDEN_BG})`, backgroundColor: '#5c4033' }}>
                                    <div className="grid grid-cols-5 gap-0 border-2 border-black/10 shadow-inner">
                                        {Array.from({ length: 25 }).map((_, i) => (
                                            <GridCell key={i} x={i%5} y={Math.floor(i/5)} cell={(getGardens()[activeGardenIdx] || {})[`${i%5},${Math.floor(i/5)}`] || {}} handleGridClick={handleGridClick} now={now} />
                                        ))}
                                    </div>
                                </div>

                                {!isSpectator && <div className="mt-8 w-full max-w-2xl bg-white p-4 rounded-2xl shadow-lg border border-gray-100"><h3 className="text-xs font-bold text-gray-400 uppercase mb-3">Werkzeugkasten</h3><div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">{Object.entries(getInventory()).map(([id, count]) => { if (count <= 0) return null; return <button key={id} onClick={() => setSelectedItem(selectedItem === id ? null : id)} className={`flex-shrink-0 flex flex-col items-center p-3 rounded-xl border-2 transition-all min-w-[80px] ${selectedItem === id ? 'border-blue-500 bg-blue-50 shadow-md transform -translate-y-1' : 'border-gray-100 hover:bg-gray-50'}`}><ItemDisplay item={ITEMS[id]} className="w-8 h-8" /><span className="text-xs font-bold text-gray-600">{count}x</span></button> })}</div></div>}
                            </div>
                        )}
                        
                        {tab === 'tasks' && !isSpectator && (
                            <div className="p-6 md:max-w-3xl md:mx-auto">
                                <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-gray-700">Aufgaben</h2><button onClick={() => setTaskModalOpen(true)} className="bg-blue-500 text-white px-4 py-2 rounded-xl font-bold shadow-lg flex items-center gap-2"><Icon name="plus" /> Neu</button></div>
                                <div className="flex gap-2 mb-4 bg-white p-1 rounded-xl w-fit border border-gray-200"><button onClick={() => setTaskFilter('active')} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${taskFilter === 'active' ? 'bg-blue-100 text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}>Offen</button><button onClick={() => setTaskFilter('done')} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${taskFilter === 'done' ? 'bg-green-100 text-green-600' : 'text-gray-400 hover:text-gray-600'}`}>Erledigt</button></div>
                                <div className="space-y-3 pb-12">
                                    {getTasks().filter(task => { const today = new Date().toISOString().split('T')[0]; const isDoneToday = task.type === 'daily' && task.lastDone === today; const isDoneEver = task.type === 'once' && task.done; return taskFilter === 'active' ? (!isDoneEver && !isDoneToday) : (isDoneEver || isDoneToday); }).map(task => (
                                        <div key={task.id} className={`bg-white p-5 rounded-2xl shadow-sm border ${taskFilter === 'done' ? 'border-green-100 opacity-80' : 'border-gray-100'} flex justify-between items-center`}>
                                            <div className="flex flex-col gap-1">
                                                <div className="flex items-center gap-2"><span className={`font-bold text-lg ${taskFilter === 'done' ? 'text-gray-400 line-through' : 'text-gray-800'}`}>{task.title}</span>{task.type === 'daily' && <span className="text-blue-500"><Icon name="repeat" size={14}/></span>}</div>
                                                <div className="flex gap-3 text-xs">{taskFilter === 'done' ? <span className="text-gray-500 flex items-center gap-1"><Icon name="check-circle" size={12}/> {task.completedBy} ({task.completedAt})</span> : <><span className="text-green-600 font-bold">+{task.reward} M√ºnzen</span>{task.deadline && <span className="text-red-400 font-bold flex items-center gap-1"><Icon name="calendar" size={10}/> {task.deadline}</span>}</>}</div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => deleteTask(task)} className="w-8 h-8 rounded-full border-2 border-red-100 hover:border-red-500 hover:bg-red-50 flex items-center justify-center transition-colors text-red-300 hover:text-red-500"><Icon name="trash-2" size={14}/></button>
                                                {taskFilter === 'active' && <button onClick={() => toggleTask(task)} className="w-8 h-8 rounded-full border-2 border-gray-300 hover:border-green-500 hover:bg-green-50 flex items-center justify-center transition-colors"><Icon name="check" className="text-transparent hover:text-green-500 w-4 h-4"/></button>}
                                            </div>
                                        </div>
                                    ))}
                                    {getTasks().filter(t => taskFilter === 'active' ? (!t.done || (t.type==='daily' && t.lastDone!==new Date().toISOString().split('T')[0])) : (t.done || (t.type==='daily' && t.lastDone===new Date().toISOString().split('T')[0]))).length === 0 && <div className="text-center py-8 text-gray-400 italic">Keine Aufgaben in dieser Liste.</div>}
                                </div>
                            </div>
                        )}
                        
                        {tab === 'shop' && !isSpectator && (
                            <div className="p-6 md:max-w-4xl md:mx-auto pb-32">
                                <h3 className="font-bold text-xl text-purple-700 mb-4 flex items-center gap-2"><Icon name="castle"/> Immobilien (Gems)</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">{GARDEN_UPGRADES.filter(g => g.id > 0).map(g => { const owned = (roomData.unlockedGardens || []).includes(g.id); return <div key={g.id} className={`p-4 rounded-2xl border-2 flex flex-col items-center ${owned ? 'bg-gray-50 border-gray-200' : 'bg-purple-50 border-purple-200'}`}><div className="text-3xl mb-2">üèûÔ∏è</div><div className="font-bold">{g.name}</div><button onClick={() => !owned && buy(g.id, true)} disabled={owned || roomData.gems < g.price} className={`mt-2 w-full py-2 rounded-xl text-sm font-bold ${owned ? 'text-gray-400 bg-gray-200' : 'bg-purple-600 text-white'}`}>{owned ? 'Gekauft' : `${g.price} üíé`}</button></div> })}</div>
                                <h3 className="font-bold text-xl text-orange-600 mb-4 flex items-center gap-2"><Icon name="store"/> Markt (M√ºnzen)</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">{Object.values(ITEMS).map(item => (<div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center"><div className={`text-4xl mb-3 mt-2 ${item.css ? item.css + ' w-12 h-12 rounded flex items-center justify-center' : ''}`}>{item.icon && !item.img && item.icon}<ItemDisplay item={item} className="w-12 h-12" /></div><h3 className="font-bold text-gray-700 text-center text-sm">{item.name}</h3><button onClick={() => buy(item.id, false)} disabled={roomData.coins < item.price} className={`mt-2 w-full py-2 rounded-xl text-sm font-bold transition-all ${roomData.coins >= item.price ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-400'}`}>{item.price} üí∞</button></div>))}</div>
                            </div>
                        )}

                        {/* NEUER OCTO TAB (HIER INTEGRIERT) */}
                        {tab === 'octo' && !isSpectator && (
                            <div className="h-full bg-[#f0f9ff] flex flex-col">
                                <OctoChatInterface context={octoContext} />
                            </div>
                        )}
                    </main>
                    {isTaskModalOpen && (
                        <Modal title="Neue Aufgabe" onClose={() => setTaskModalOpen(false)}><div className="space-y-4"><div><label className="text-xs font-bold text-gray-400 uppercase">Titel</label><input value={newTaskTitle} onChange={e => setNewTaskTitle(e.target.value)} placeholder="Titel..." className="w-full border rounded-xl p-3 outline-none focus:ring-2 ring-blue-500" /></div><div className="flex gap-4"><div className="flex-1"><label className="text-xs font-bold text-gray-400 uppercase">Belohnung: {newTaskReward}</label><input type="range" min="10" max="100" step="5" value={newTaskReward} onChange={e => setNewTaskReward(e.target.value)} className="w-full accent-blue-500 mt-2" /></div></div><div className="flex gap-4"><div className="flex-1"><label className="text-xs font-bold text-gray-400 uppercase">Typ</label><select value={newTaskType} onChange={e => setNewTaskType(e.target.value)} className="w-full border rounded-xl p-2 mt-1"><option value="once">Einmalig</option><option value="daily">T√§glich</option></select></div><div className="flex-1"><label className="text-xs font-bold text-gray-400 uppercase">Frist</label><input type="date" value={newTaskDeadline} onChange={e => setNewTaskDeadline(e.target.value)} className="w-full border rounded-xl p-2 mt-1" /></div></div><div className="flex gap-2 mt-2"><button onClick={() => setTaskModalOpen(false)} className="flex-1 bg-gray-200 text-gray-600 font-bold py-3 rounded-xl">Abbrechen</button><button onClick={createTask} className="flex-1 bg-blue-500 text-white font-bold py-3 rounded-xl">Erstellen</button></div></div></Modal>
                    )}
                    <OctoChat user={user} />
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [view, setView] = React.useState('login'); // login, menu, game, community
            const [currentRoom, setCurrentRoom] = React.useState(localStorage.getItem('lastRoom') || null);
            const [isSpectator, setIsSpectator] = React.useState(false);

            React.useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                    if (u) setView('menu');
                    else setView('login');
                });
                return () => unsub();
            }, []);

            const handleLogin = async () => {
                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                } catch (e) {
                    alert("Login fehlgeschlagen: " + e.message);
                }
            };

            const handleMenuAction = async (action, payload, payload2) => {
                if (action === 'community') {
                    setView('community');
                } else if (action === 'create') {
                    // Payload2 ist hier der Name des Gartens
                    const newCode = Math.random().toString(36).substring(2, 7).toUpperCase();
                    const gardenName = payload2 || "Mein Garten";
                    
                    await setDoc(doc(db, 'rooms', newCode), {
                        roomName: gardenName,
                        owner: user.uid,
                        ownerName: user.displayName,
                        createdAt: new Date().toISOString(),
                        users: [user.uid],
                        tasks: [],
                        inventory: { carrot_seed: 2 }, // Start-Items
                        coins: 50,
                        gems: 0,
                        gardens: { 0: {} },
                        unlockedGardens: [0],
                        likes: 0
                    });
                    enterRoom(newCode, false);
                } else if (action === 'join' || action === 'resume') {
                    const code = payload;
                    const snap = await getDoc(doc(db, 'rooms', code));
                    if (snap.exists()) {
                        enterRoom(code, false);
                    } else {
                        alert("Garten nicht gefunden!");
                    }
                }
            };

            const enterRoom = (code, spectator) => {
                if (!spectator) {
                    localStorage.setItem('lastRoom', code);
                }
                setCurrentRoom(code);
                setIsSpectator(spectator);
                setView('game');
            };

            const handleBackToMenu = () => {
                if (isSpectator) {
                    const myLastRoom = localStorage.getItem('lastRoom');
                    setCurrentRoom(myLastRoom);
                    setIsSpectator(false);
                }
                setView('menu');
            };

            if (loading) return <div className="h-full flex items-center justify-center bg-slate-50 text-green-600 animate-pulse"><Icon name="loader-2" className="animate-spin mr-2"/> Lade DuoBloom...</div>;

            if (!user) return <LoginScreen onLogin={handleLogin} />;

            return (
                <ErrorBoundary roomCode={currentRoom}>
                    {view === 'menu' && <MainMenu user={user} currentRoom={currentRoom} onAction={handleMenuAction} />}
                    {view === 'community' && <CommunityList onVisit={(id) => enterRoom(id, true)} onBack={() => setView('menu')} />}
                    {view === 'game' && <GameApp user={user} roomCode={currentRoom} isSpectator={isSpectator} onBackToMenu={handleBackToMenu} />}
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

